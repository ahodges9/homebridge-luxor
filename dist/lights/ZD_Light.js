"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ILightType = exports.ZD_Light = void 0;
class ZD_Light {
    constructor(platform, accessory) {
        this.controller = platform.controller;
        this.accessory = accessory;
        this.log = platform.log;
        this.platform = platform;
        this.context = this.accessory.context;
        this.log.info(`Initializing ${this.accessory.displayName}.`);
        this.setServices();
    }
    setServices() {
        // Make sure you provided a name for service otherwise it may not visible in some HomeKit apps.
        // if (this.context.status === 'new') {
        try {
            this.accessory.getService(this.platform.Service.AccessoryInformation)
                .setCharacteristic(this.platform.Characteristic.Manufacturer, "Luxor")
                .setCharacteristic(this.platform.Characteristic.Model, this.context.type);
            this.service = this.accessory.getService(this.platform.Service.Lightbulb) || this.accessory.addService(this.platform.Service.Lightbulb);
            this.service.setCharacteristic(this.platform.Characteristic.Name, this.accessory.displayName);
            this.service.getCharacteristic(this.platform.Characteristic.On)
                .on('get', this.getOn.bind(this))
                .on('set', this.setOn.bind(this));
            this.service.getCharacteristic(this.platform.Characteristic.Brightness)
                .on('set', this.setBrightness.bind(this))
                .on('get', this.getBrightness.bind(this));
            this.context.status = 'current';
            try {
                this.getCurrentStateAsync().then(() => {
                    this.setCharacteristics();
                });
            }
            catch (err) {
                this.log.error(`${this.accessory.displayName} setServices error: ${err}`);
            }
        }
        catch (err) {
            this.log.error(`setServices ${err}`);
        }
        this.accessory.on('identify', async () => {
            this.log.info(`Identifying ${this.accessory.displayName}.  Lights will flash thrice.`);
            await this.illuminateGroupAsync(100);
            await this.sleep(3000);
            await this.illuminateGroupAsync(0);
            await this.sleep(3000);
            await this.illuminateGroupAsync(100);
            await this.sleep(3000);
            await this.illuminateGroupAsync(0);
        });
        this.controller.registerCallback(this.accessory.UUID, this.context.type, this.context.groupNumber, this.platform.Characteristic.Brightness, this.callbackBrightness.bind(this));
    }
    async sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    getOn(callback) {
        try {
            // this.log.debug("Getting power state for: ", this.accessory.displayName);
            this.getCurrentStateAsync().then(() => {
                callback(null, this.context.isOn);
            });
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} error: ${err}`);
            this.context.isOn = false;
            callback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */, false);
        }
    }
    setOn(desiredState, callback) {
        try {
            if (this.context.isOn === desiredState) {
                this.log.debug('Not changing power to %s because it is already %s', desiredState ? 'On' : 'Off', this.context.isOn ? 'On' : 'Off');
                callback(null);
            }
            else {
                this.illuminateGroupAsync(desiredState ? this.context.brightness || 100 : 0).then(() => callback(null));
            }
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} setOn error: ${err}`);
            callback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */);
        }
    }
    getBrightness(callback) {
        try {
            this.getCurrentStateAsync().then(() => { callback(null, this.context.brightness); });
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} getBrightness error: ${err}`);
            callback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */, false);
        }
    }
    setBrightness(desiredBrightness, callback) {
        try {
            if (this.context.brightness === desiredBrightness) {
                this.log.debug('Not changing brightness to %s because it is already %s', desiredBrightness, this.context.brightness);
                callback(null);
            }
            else {
                this.illuminateGroupAsync(desiredBrightness).then(() => {
                    callback(null);
                });
            }
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} setBrightness error: ${err}`);
            callback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */, false);
        }
    }
    async illuminateGroupAsync(desiredIntensity) {
        return new Promise(async (resolve, reject) => {
            try {
                this.log.info(`${this.accessory.displayName} turning ${desiredIntensity > 0 ? 'on' : 'off'} with brightness ${desiredIntensity}`);
                let result = await this.controller.IlluminateGroupAsync(this.context.groupNumber, desiredIntensity);
                if (result.StatusStr === 'Ok') {
                    this.context.brightness = desiredIntensity;
                    this.context.isOn = this.context.brightness > 0;
                    this.service.updateCharacteristic(this.platform.Characteristic.On, desiredIntensity > 0);
                    this.service.updateCharacteristic(this.platform.Characteristic.Brightness, desiredIntensity);
                    resolve();
                }
                else {
                    this.log.error(`${this.accessory.displayName} returned ${result.StatusStr} trying to set intensity ${desiredIntensity}.`);
                    reject();
                }
            }
            catch (err) {
                this.log.error(`${this.accessory.displayName} illuminateGroupAsync error: ${err}`);
                reject(err);
            }
            ;
        });
    }
    setCharacteristics() {
        this.service.updateCharacteristic(this.platform.Characteristic.On, typeof this.context.isOn !== 'undefined' ? this.context.isOn : false);
        this.service.updateCharacteristic(this.platform.Characteristic.Brightness, typeof this.context.brightness !== 'undefined' ? this.context.brightness : 0);
    }
    // this method used for event handling
    async getCurrentStateAsync() {
        return new Promise(async (resolve, reject) => {
            try {
                let group = await this.controller.GetGroupAsync(this.context.groupNumber);
                this.context.brightness = group.Intensity;
                this.context.isOn = this.context.brightness > 0;
                resolve();
            }
            catch (err) {
                this.log.error(`${this.accessory.displayName} getCurrentStateAsync error: ${err}`);
                reject(err);
            }
            ;
        });
    }
    // this method used for callbacks
    callbackBrightness(intensity) {
        if (intensity !== this.context.brightness) {
            this.context.brightness = intensity;
            this.context.isOn = intensity > 0;
            this.log.debug(`${this.accessory.displayName} updated isOn to ${intensity > 0} and brightness ${intensity}.`);
            this.service.updateCharacteristic(this.platform.Characteristic.On, intensity > 0);
            this.service.updateCharacteristic(this.platform.Characteristic.Brightness, intensity);
        }
    }
}
exports.ZD_Light = ZD_Light;
var ILightType;
(function (ILightType) {
    ILightType["ZD"] = "ZD";
    ILightType["ZDC"] = "ZDC";
    ILightType["THEME"] = "Theme";
})(ILightType = exports.ILightType || (exports.ILightType = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWkRfTGlnaHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGlnaHRzL1pEX0xpZ2h0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUtBLE1BQWEsUUFBUTtJQU9qQixZQUFZLFFBQXVCLEVBQUUsU0FBNEI7UUFDN0QsSUFBSSxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQztRQUN4QixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBbUIsQ0FBQztRQUNsRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBQ0QsV0FBVztRQUNQLCtGQUErRjtRQUMvRix1Q0FBdUM7UUFFdkMsSUFBSTtZQUVBLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDO2lCQUNwRSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsT0FBTyxDQUFDO2lCQUNyRSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUUxRSxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3hJLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDOUYsSUFBSSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUM7aUJBQzlELEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ2hDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUVsQyxJQUFJLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQztpQkFDdEUsRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDeEMsRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBRTFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQztZQUNoQyxJQUFJO2dCQUNBLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7b0JBQ2xDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO2dCQUM5QixDQUFDLENBQUMsQ0FBQzthQUNOO1lBQ0QsT0FBTSxHQUFHLEVBQUM7Z0JBQ04sSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsdUJBQXVCLEdBQUcsRUFBRSxDQUFDLENBQUE7YUFDNUU7U0FDSjtRQUNELE9BQU8sR0FBRyxFQUFDO1lBQ1AsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsZUFBZSxHQUFHLEVBQUUsQ0FBQyxDQUFBO1NBQ3ZDO1FBR0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsVUFBVSxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3JDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLDhCQUE4QixDQUFDLENBQUM7WUFDdkYsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckMsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3ZCLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25DLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN2QixNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNyQyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDdEIsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDcEwsQ0FBQztJQUNELEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUNWLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUNELEtBQUssQ0FBQyxRQUFtQztRQUNyQyxJQUFJO1lBQ0EsMkVBQTJFO1lBQzNFLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7Z0JBQ2xDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN0QyxDQUFDLENBQUMsQ0FBQztTQUNOO1FBQ0QsT0FBTyxHQUFHLEVBQUU7WUFDUixJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxXQUFXLEdBQUcsRUFBRSxDQUFDLENBQUE7WUFDN0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO1lBQzFCLFFBQVEsNENBQXlDLEtBQUssQ0FBQyxDQUFDO1NBQzNEO0lBQ0wsQ0FBQztJQUNELEtBQUssQ0FBQyxZQUFxQixFQUFFLFFBQW1DO1FBQzVELElBQUk7WUFDQSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLFlBQVksRUFBRTtnQkFDcEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsbURBQW1ELEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDbkksUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2xCO2lCQUFNO2dCQUNILElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2FBQzNHO1NBQ0o7UUFDRCxPQUFPLEdBQUcsRUFBRTtZQUNSLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLGlCQUFpQixHQUFHLEVBQUUsQ0FBQyxDQUFBO1lBQ25FLFFBQVEsMkNBQXdDLENBQUM7U0FDcEQ7SUFDTCxDQUFDO0lBQ0QsYUFBYSxDQUFDLFFBQW1DO1FBQzdDLElBQUk7WUFDQSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDeEY7UUFDRCxPQUFPLEdBQUcsRUFBRTtZQUNSLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLHlCQUF5QixHQUFHLEVBQUUsQ0FBQyxDQUFBO1lBQzNFLFFBQVEsNENBQXlDLEtBQUssQ0FBQyxDQUFDO1NBQzNEO0lBQ0wsQ0FBQztJQUNELGFBQWEsQ0FBQyxpQkFBeUIsRUFBRSxRQUFtQztRQUN4RSxJQUFJO1lBQ0EsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsS0FBSyxpQkFBaUIsRUFBRTtnQkFDL0MsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsd0RBQXdELEVBQUUsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDckgsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2xCO2lCQUFNO2dCQUNILElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7b0JBQ25ELFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDbkIsQ0FBQyxDQUFDLENBQUM7YUFDTjtTQUNKO1FBQ0QsT0FBTyxHQUFHLEVBQUU7WUFDUixJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyx5QkFBeUIsR0FBRyxFQUFFLENBQUMsQ0FBQTtZQUMzRSxRQUFRLDRDQUF5QyxLQUFLLENBQUMsQ0FBQztTQUMzRDtJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsb0JBQW9CLENBQUMsZ0JBQXdCO1FBQy9DLE9BQU8sSUFBSSxPQUFPLENBQUMsS0FBSyxFQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUMsRUFBRTtZQUN2QyxJQUFJO2dCQUNBLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLFlBQVksZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssb0JBQW9CLGdCQUFnQixFQUFFLENBQUMsQ0FBQztnQkFDbEksSUFBSSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLGdCQUFnQixDQUFDLENBQUM7Z0JBQ3BHLElBQUksTUFBTSxDQUFDLFNBQVMsS0FBSyxJQUFJLEVBQUU7b0JBQzNCLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLGdCQUFnQixDQUFDO29CQUMzQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUM7b0JBQ2hELElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsRUFBRSxFQUFFLGdCQUFnQixHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUN6RixJQUFJLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLFVBQVUsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO29CQUM3RixPQUFPLEVBQUUsQ0FBQztpQkFDYjtxQkFDSTtvQkFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxhQUFhLE1BQU0sQ0FBQyxTQUFTLDRCQUE0QixnQkFBZ0IsR0FBRyxDQUFDLENBQUE7b0JBQ3pILE1BQU0sRUFBRSxDQUFDO2lCQUNaO2FBQ0o7WUFDRCxPQUFPLEdBQUcsRUFBRTtnQkFDUixJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxnQ0FBZ0MsR0FBRyxFQUFFLENBQUMsQ0FBQTtnQkFDbEYsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ2Y7WUFBQSxDQUFDO1FBQ04sQ0FBQyxDQUFDLENBQUE7SUFDRixDQUFDO0lBQ0wsa0JBQWtCO1FBQ2QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxFQUFFLEVBQUUsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6SSxJQUFJLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLFVBQVUsRUFBRSxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdKLENBQUM7SUFDRCxzQ0FBc0M7SUFDdEMsS0FBSyxDQUFDLG9CQUFvQjtRQUN0QixPQUFPLElBQUksT0FBTyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDekMsSUFBSTtnQkFDQSxJQUFJLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQzFFLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7Z0JBQzFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQztnQkFDaEQsT0FBTyxFQUFFLENBQUM7YUFDYjtZQUNELE9BQU8sR0FBRyxFQUFFO2dCQUNSLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLGdDQUFnQyxHQUFHLEVBQUUsQ0FBQyxDQUFBO2dCQUNsRixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7YUFDZDtZQUFBLENBQUM7UUFDTixDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUM7SUFDRCxpQ0FBaUM7SUFDakMsa0JBQWtCLENBQUMsU0FBaUI7UUFFaEMsSUFBSSxTQUFTLEtBQUssSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUU7WUFDdkMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLFNBQVMsR0FBRyxDQUFDLENBQUM7WUFDbEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsb0JBQW9CLFNBQVMsR0FBRyxDQUFDLG1CQUFtQixTQUFTLEdBQUcsQ0FBQyxDQUFDO1lBQzlHLElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsRUFBRSxFQUFFLFNBQVMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNsRixJQUFJLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLFVBQVUsRUFBRSxTQUFTLENBQUMsQ0FBQztTQUN6RjtJQUNMLENBQUM7Q0FDSjtBQTVLRCw0QkE0S0M7QUFFRCxJQUFZLFVBRVg7QUFGRCxXQUFZLFVBQVU7SUFDbEIsdUJBQVMsQ0FBQTtJQUFFLHlCQUFXLENBQUE7SUFBRSw2QkFBZSxDQUFBO0FBQzNDLENBQUMsRUFGVyxVQUFVLEdBQVYsa0JBQVUsS0FBVixrQkFBVSxRQUVyQiIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgU2VydmljZSwgUGxhdGZvcm1BY2Nlc3NvcnksIENoYXJhY3RlcmlzdGljVmFsdWUsIENoYXJhY3RlcmlzdGljU2V0Q2FsbGJhY2ssIENoYXJhY3RlcmlzdGljR2V0Q2FsbGJhY2ssIExvZ2dlciwgSEFQU3RhdHVzIH0gZnJvbSAnaG9tZWJyaWRnZSc7XG5pbXBvcnQgeyBJQ29udGV4dCwgTHV4b3JQbGF0Zm9ybSB9IGZyb20gJy4uL0x1eG9yUGxhdGZvcm0nO1xuaW1wb3J0IHsgQmFzZUNvbnRyb2xsZXIgfSBmcm9tICcuLi9jb250cm9sbGVyL0Jhc2VDb250cm9sbGVyJztcblxuZXhwb3J0IGNsYXNzIFpEX0xpZ2h0IHtcbiAgICBwcm90ZWN0ZWQgYWNjZXNzb3J5OiBQbGF0Zm9ybUFjY2Vzc29yeTtcbiAgICBwcm90ZWN0ZWQgbG9nOiBMb2dnZXI7XG4gICAgcHJvdGVjdGVkIHNlcnZpY2U6IFNlcnZpY2U7XG4gICAgcHJvdGVjdGVkIGNvbnRyb2xsZXI6IEJhc2VDb250cm9sbGVyO1xuICAgIHByb3RlY3RlZCBwbGF0Zm9ybTogTHV4b3JQbGF0Zm9ybTtcbiAgICBwcm90ZWN0ZWQgY29udGV4dDogSUNvbnRleHQ7XG4gICAgY29uc3RydWN0b3IocGxhdGZvcm06IEx1eG9yUGxhdGZvcm0sIGFjY2Vzc29yeTogUGxhdGZvcm1BY2Nlc3NvcnkpIHtcbiAgICAgICAgdGhpcy5jb250cm9sbGVyID0gcGxhdGZvcm0uY29udHJvbGxlcjtcbiAgICAgICAgdGhpcy5hY2Nlc3NvcnkgPSBhY2Nlc3Nvcnk7XG4gICAgICAgIHRoaXMubG9nID0gcGxhdGZvcm0ubG9nO1xuICAgICAgICB0aGlzLnBsYXRmb3JtID0gcGxhdGZvcm07XG4gICAgICAgIHRoaXMuY29udGV4dCA9IHRoaXMuYWNjZXNzb3J5LmNvbnRleHQgYXMgSUNvbnRleHQ7XG4gICAgICAgIHRoaXMubG9nLmluZm8oYEluaXRpYWxpemluZyAke3RoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lfS5gKTtcbiAgICAgICAgdGhpcy5zZXRTZXJ2aWNlcygpO1xuICAgIH1cbiAgICBzZXRTZXJ2aWNlcygpIHtcbiAgICAgICAgLy8gTWFrZSBzdXJlIHlvdSBwcm92aWRlZCBhIG5hbWUgZm9yIHNlcnZpY2Ugb3RoZXJ3aXNlIGl0IG1heSBub3QgdmlzaWJsZSBpbiBzb21lIEhvbWVLaXQgYXBwcy5cbiAgICAgICAgLy8gaWYgKHRoaXMuY29udGV4dC5zdGF0dXMgPT09ICduZXcnKSB7XG5cbiAgICAgICAgdHJ5IHtcblxuICAgICAgICAgICAgdGhpcy5hY2Nlc3NvcnkuZ2V0U2VydmljZSh0aGlzLnBsYXRmb3JtLlNlcnZpY2UuQWNjZXNzb3J5SW5mb3JtYXRpb24pXG4gICAgICAgICAgICAuc2V0Q2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5NYW51ZmFjdHVyZXIsIFwiTHV4b3JcIilcbiAgICAgICAgICAgIC5zZXRDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLk1vZGVsLCB0aGlzLmNvbnRleHQudHlwZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuc2VydmljZSA9IHRoaXMuYWNjZXNzb3J5LmdldFNlcnZpY2UodGhpcy5wbGF0Zm9ybS5TZXJ2aWNlLkxpZ2h0YnVsYikgfHwgdGhpcy5hY2Nlc3NvcnkuYWRkU2VydmljZSh0aGlzLnBsYXRmb3JtLlNlcnZpY2UuTGlnaHRidWxiKTtcbiAgICAgICAgICAgIHRoaXMuc2VydmljZS5zZXRDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLk5hbWUsIHRoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lKTtcbiAgICAgICAgICAgIHRoaXMuc2VydmljZS5nZXRDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLk9uKVxuICAgICAgICAgICAgLm9uKCdnZXQnLCB0aGlzLmdldE9uLmJpbmQodGhpcykpXG4gICAgICAgICAgICAub24oJ3NldCcsIHRoaXMuc2V0T24uYmluZCh0aGlzKSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuc2VydmljZS5nZXRDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLkJyaWdodG5lc3MpXG4gICAgICAgICAgICAub24oJ3NldCcsIHRoaXMuc2V0QnJpZ2h0bmVzcy5iaW5kKHRoaXMpKVxuICAgICAgICAgICAgLm9uKCdnZXQnLCB0aGlzLmdldEJyaWdodG5lc3MuYmluZCh0aGlzKSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdGF0dXMgPSAnY3VycmVudCc7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHRoaXMuZ2V0Q3VycmVudFN0YXRlQXN5bmMoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDaGFyYWN0ZXJpc3RpY3MoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoKGVycil7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYCR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9IHNldFNlcnZpY2VzIGVycm9yOiAke2Vycn1gKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnIpe1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYHNldFNlcnZpY2VzICR7ZXJyfWApXG4gICAgICAgIH1cblxuXG4gICAgICAgIHRoaXMuYWNjZXNzb3J5Lm9uKCdpZGVudGlmeScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9nLmluZm8oYElkZW50aWZ5aW5nICR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9LiAgTGlnaHRzIHdpbGwgZmxhc2ggdGhyaWNlLmApO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5pbGx1bWluYXRlR3JvdXBBc3luYygxMDApO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5zbGVlcCgzMDAwKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuaWxsdW1pbmF0ZUdyb3VwQXN5bmMoMCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnNsZWVwKDMwMDApO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5pbGx1bWluYXRlR3JvdXBBc3luYygxMDApO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5zbGVlcCgzMDAwKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5pbGx1bWluYXRlR3JvdXBBc3luYygwKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY29udHJvbGxlci5yZWdpc3RlckNhbGxiYWNrKHRoaXMuYWNjZXNzb3J5LlVVSUQsIHRoaXMuY29udGV4dC50eXBlLCB0aGlzLmNvbnRleHQuZ3JvdXBOdW1iZXIsIHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuQnJpZ2h0bmVzcywgdGhpcy5jYWxsYmFja0JyaWdodG5lc3MuYmluZCh0aGlzKSk7XG4gICAgfVxuICAgIGFzeW5jIHNsZWVwKG1zKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTtcbiAgICB9XG4gICAgZ2V0T24oY2FsbGJhY2s6IENoYXJhY3RlcmlzdGljR2V0Q2FsbGJhY2spOiB2b2lkIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIHRoaXMubG9nLmRlYnVnKFwiR2V0dGluZyBwb3dlciBzdGF0ZSBmb3I6IFwiLCB0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZSk7XG4gICAgICAgICAgICB0aGlzLmdldEN1cnJlbnRTdGF0ZUFzeW5jKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgdGhpcy5jb250ZXh0LmlzT24pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYCR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9IGVycm9yOiAke2Vycn1gKVxuICAgICAgICAgICAgdGhpcy5jb250ZXh0LmlzT24gPSBmYWxzZTtcbiAgICAgICAgICAgIGNhbGxiYWNrKEhBUFN0YXR1cy5OT1RfQUxMT1dFRF9JTl9DVVJSRU5UX1NUQVRFLCBmYWxzZSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgc2V0T24oZGVzaXJlZFN0YXRlOiBib29sZWFuLCBjYWxsYmFjazogQ2hhcmFjdGVyaXN0aWNTZXRDYWxsYmFjayk6IHZvaWQge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKHRoaXMuY29udGV4dC5pc09uID09PSBkZXNpcmVkU3RhdGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnTm90IGNoYW5naW5nIHBvd2VyIHRvICVzIGJlY2F1c2UgaXQgaXMgYWxyZWFkeSAlcycsIGRlc2lyZWRTdGF0ZSA/ICdPbicgOiAnT2ZmJywgdGhpcy5jb250ZXh0LmlzT24gPyAnT24nIDogJ09mZicpO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmlsbHVtaW5hdGVHcm91cEFzeW5jKGRlc2lyZWRTdGF0ZSA/IHRoaXMuY29udGV4dC5icmlnaHRuZXNzIHx8IDEwMCA6IDApLnRoZW4oKCkgPT4gY2FsbGJhY2sobnVsbCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGAke3RoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lfSBzZXRPbiBlcnJvcjogJHtlcnJ9YClcbiAgICAgICAgICAgIGNhbGxiYWNrKEhBUFN0YXR1cy5OT1RfQUxMT1dFRF9JTl9DVVJSRU5UX1NUQVRFKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBnZXRCcmlnaHRuZXNzKGNhbGxiYWNrOiBDaGFyYWN0ZXJpc3RpY0dldENhbGxiYWNrKTogdm9pZCB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLmdldEN1cnJlbnRTdGF0ZUFzeW5jKCkudGhlbigoKSA9PiB7IGNhbGxiYWNrKG51bGwsIHRoaXMuY29udGV4dC5icmlnaHRuZXNzKTsgfSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYCR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9IGdldEJyaWdodG5lc3MgZXJyb3I6ICR7ZXJyfWApXG4gICAgICAgICAgICBjYWxsYmFjayhIQVBTdGF0dXMuTk9UX0FMTE9XRURfSU5fQ1VSUkVOVF9TVEFURSwgZmFsc2UpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHNldEJyaWdodG5lc3MoZGVzaXJlZEJyaWdodG5lc3M6IG51bWJlciwgY2FsbGJhY2s6IENoYXJhY3RlcmlzdGljU2V0Q2FsbGJhY2spOiB2b2lkIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbnRleHQuYnJpZ2h0bmVzcyA9PT0gZGVzaXJlZEJyaWdodG5lc3MpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnTm90IGNoYW5naW5nIGJyaWdodG5lc3MgdG8gJXMgYmVjYXVzZSBpdCBpcyBhbHJlYWR5ICVzJywgZGVzaXJlZEJyaWdodG5lc3MsIHRoaXMuY29udGV4dC5icmlnaHRuZXNzKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbGx1bWluYXRlR3JvdXBBc3luYyhkZXNpcmVkQnJpZ2h0bmVzcykudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGAke3RoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lfSBzZXRCcmlnaHRuZXNzIGVycm9yOiAke2Vycn1gKVxuICAgICAgICAgICAgY2FsbGJhY2soSEFQU3RhdHVzLk5PVF9BTExPV0VEX0lOX0NVUlJFTlRfU1RBVEUsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGlsbHVtaW5hdGVHcm91cEFzeW5jKGRlc2lyZWRJbnRlbnNpdHk6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMocmVzb2x2ZSwgcmVqZWN0KT0+e1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5pbmZvKGAke3RoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lfSB0dXJuaW5nICR7ZGVzaXJlZEludGVuc2l0eSA+IDAgPyAnb24nIDogJ29mZid9IHdpdGggYnJpZ2h0bmVzcyAke2Rlc2lyZWRJbnRlbnNpdHl9YCk7XG4gICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY29udHJvbGxlci5JbGx1bWluYXRlR3JvdXBBc3luYyh0aGlzLmNvbnRleHQuZ3JvdXBOdW1iZXIsIGRlc2lyZWRJbnRlbnNpdHkpO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuU3RhdHVzU3RyID09PSAnT2snKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5icmlnaHRuZXNzID0gZGVzaXJlZEludGVuc2l0eTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmlzT24gPSB0aGlzLmNvbnRleHQuYnJpZ2h0bmVzcyA+IDA7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VydmljZS51cGRhdGVDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLk9uLCBkZXNpcmVkSW50ZW5zaXR5ID4gMCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VydmljZS51cGRhdGVDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLkJyaWdodG5lc3MsIGRlc2lyZWRJbnRlbnNpdHkpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgJHt0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZX0gcmV0dXJuZWQgJHtyZXN1bHQuU3RhdHVzU3RyfSB0cnlpbmcgdG8gc2V0IGludGVuc2l0eSAke2Rlc2lyZWRJbnRlbnNpdHl9LmApXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgJHt0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZX0gaWxsdW1pbmF0ZUdyb3VwQXN5bmMgZXJyb3I6ICR7ZXJyfWApXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9KVxuICAgICAgICB9XG4gICAgc2V0Q2hhcmFjdGVyaXN0aWNzKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnNlcnZpY2UudXBkYXRlQ2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5PbiwgdHlwZW9mIHRoaXMuY29udGV4dC5pc09uICE9PSAndW5kZWZpbmVkJyA/IHRoaXMuY29udGV4dC5pc09uIDogZmFsc2UpO1xuICAgICAgICB0aGlzLnNlcnZpY2UudXBkYXRlQ2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5CcmlnaHRuZXNzLCB0eXBlb2YgdGhpcy5jb250ZXh0LmJyaWdodG5lc3MgIT09ICd1bmRlZmluZWQnID8gdGhpcy5jb250ZXh0LmJyaWdodG5lc3MgOiAwKTtcbiAgICB9XG4gICAgLy8gdGhpcyBtZXRob2QgdXNlZCBmb3IgZXZlbnQgaGFuZGxpbmdcbiAgICBhc3luYyBnZXRDdXJyZW50U3RhdGVBc3luYygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgbGV0IGdyb3VwID0gYXdhaXQgdGhpcy5jb250cm9sbGVyLkdldEdyb3VwQXN5bmModGhpcy5jb250ZXh0Lmdyb3VwTnVtYmVyKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuYnJpZ2h0bmVzcyA9IGdyb3VwLkludGVuc2l0eTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuaXNPbiA9IHRoaXMuY29udGV4dC5icmlnaHRuZXNzID4gMDtcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYCR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9IGdldEN1cnJlbnRTdGF0ZUFzeW5jIGVycm9yOiAke2Vycn1gKVxuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9O1xuICAgICAgICB9KVxuICAgIH1cbiAgICAvLyB0aGlzIG1ldGhvZCB1c2VkIGZvciBjYWxsYmFja3NcbiAgICBjYWxsYmFja0JyaWdodG5lc3MoaW50ZW5zaXR5OiBudW1iZXIpOiB2b2lkIHtcblxuICAgICAgICBpZiAoaW50ZW5zaXR5ICE9PSB0aGlzLmNvbnRleHQuYnJpZ2h0bmVzcykge1xuICAgICAgICAgICAgdGhpcy5jb250ZXh0LmJyaWdodG5lc3MgPSBpbnRlbnNpdHk7XG4gICAgICAgICAgICB0aGlzLmNvbnRleHQuaXNPbiA9IGludGVuc2l0eSA+IDA7XG4gICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZyhgJHt0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZX0gdXBkYXRlZCBpc09uIHRvICR7aW50ZW5zaXR5ID4gMH0gYW5kIGJyaWdodG5lc3MgJHtpbnRlbnNpdHl9LmApO1xuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLnVwZGF0ZUNoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuT24sIGludGVuc2l0eSA+IDApO1xuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLnVwZGF0ZUNoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuQnJpZ2h0bmVzcywgaW50ZW5zaXR5KTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGVudW0gSUxpZ2h0VHlwZSB7XG4gICAgWkQgPSAnWkQnLCBaREMgPSAnWkRDJywgVEhFTUUgPSAnVGhlbWUnXG59Il19