"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ILightType = exports.ZD_Light = void 0;
class ZD_Light {
    constructor(platform, accessory) {
        this.controller = platform.controller;
        this.accessory = accessory;
        this.log = platform.log;
        this.platform = platform;
        this.context = this.accessory.context;
        this.log.info(`Initializing ${this.accessory.displayName}.`);
        this.setServices();
    }
    setServices() {
        // Make sure you provided a name for service otherwise it may not visible in some HomeKit apps.
        // if (this.context.status === 'new') {
        try {
            this.accessory.getService(this.platform.Service.AccessoryInformation)
                .setCharacteristic(this.platform.Characteristic.Manufacturer, "Luxor")
                .setCharacteristic(this.platform.Characteristic.Model, this.context.type)
                .setCharacteristic(this.platform.Characteristic.SerialNumber, this.accessory.UUID);
            this.service = this.accessory.getService(this.platform.Service.Lightbulb) || this.accessory.addService(this.platform.Service.Lightbulb);
            this.service.setCharacteristic(this.platform.Characteristic.Name, this.accessory.displayName);
            this.service.getCharacteristic(this.platform.Characteristic.On)
                .on('get', this.getOn.bind(this))
                .on('set', this.setOn.bind(this));
            this.service.getCharacteristic(this.platform.Characteristic.Brightness)
                .on('set', this.setBrightness.bind(this))
                .on('get', this.getBrightness.bind(this));
            this.context.status = 'current';
            try {
                this.getCurrentStateAsync().then(() => {
                    this.setCharacteristics();
                });
            }
            catch (err) {
                this.log.error(`${this.accessory.displayName} setServices error: ${err}`);
            }
        }
        catch (err) {
            this.log.error(`setServices ${err}`);
        }
        this.accessory.on('identify', async () => {
            this.log.info(`Identifying ${this.accessory.displayName}.  Lights will flash thrice.`);
            await this.illuminateGroupAsync(100);
            await this.sleep(3000);
            await this.illuminateGroupAsync(0);
            await this.sleep(3000);
            await this.illuminateGroupAsync(100);
            await this.sleep(3000);
            await this.illuminateGroupAsync(0);
        });
        this.controller.registerCallback(this.accessory.UUID, this.context.type, this.context.groupNumber, this.platform.Characteristic.Brightness, this.callbackBrightness.bind(this));
    }
    async sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    getOn(callback) {
        try {
            // this.log.debug("Getting power state for: ", this.accessory.displayName);
            this.getCurrentStateAsync().then(() => {
                callback(null, this.context.isOn);
            });
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} error: ${err}`);
            this.context.isOn = false;
            callback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */, false);
        }
    }
    setOn(desiredState, callback) {
        try {
            if (this.context.isOn === desiredState) {
                this.log.debug('Not changing power to %s because it is already %s', desiredState ? 'On' : 'Off', this.context.isOn ? 'On' : 'Off');
                callback(null);
            }
            else {
                this.illuminateGroupAsync(desiredState ? this.context.brightness || 100 : 0).then(() => callback(null));
            }
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} setOn error: ${err}`);
            callback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */);
        }
    }
    getBrightness(callback) {
        try {
            this.getCurrentStateAsync().then(() => { callback(null, this.context.brightness); });
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} getBrightness error: ${err}`);
            callback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */, false);
        }
    }
    setBrightness(desiredBrightness, callback) {
        try {
            if (this.context.brightness === desiredBrightness) {
                this.log.debug('Not changing brightness to %s because it is already %s', desiredBrightness, this.context.brightness);
                callback(null);
            }
            else {
                this.illuminateGroupAsync(desiredBrightness).then(() => {
                    callback(null);
                });
            }
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} setBrightness error: ${err}`);
            callback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */, false);
        }
    }
    async illuminateGroupAsync(desiredIntensity) {
        return new Promise(async (resolve, reject) => {
            try {
                this.log.info(`${this.accessory.displayName} turning ${desiredIntensity > 0 ? 'on' : 'off'} with brightness ${desiredIntensity}`);
                let result = await this.controller.IlluminateGroupAsync(this.context.groupNumber, desiredIntensity);
                if (result.StatusStr === 'Ok') {
                    this.context.brightness = desiredIntensity;
                    this.context.isOn = this.context.brightness > 0;
                    this.service.updateCharacteristic(this.platform.Characteristic.On, desiredIntensity > 0);
                    this.service.updateCharacteristic(this.platform.Characteristic.Brightness, desiredIntensity);
                    resolve();
                }
                else {
                    this.log.error(`${this.accessory.displayName} returned ${result.StatusStr} trying to set intensity ${desiredIntensity}.`);
                    reject();
                }
            }
            catch (err) {
                this.log.error(`${this.accessory.displayName} illuminateGroupAsync error: ${err}`);
                reject(err);
            }
            ;
        });
    }
    setCharacteristics() {
        this.service.updateCharacteristic(this.platform.Characteristic.On, typeof this.context.isOn !== 'undefined' ? this.context.isOn : false);
        this.service.updateCharacteristic(this.platform.Characteristic.Brightness, typeof this.context.brightness !== 'undefined' ? this.context.brightness : 0);
    }
    // this method used for event handling
    async getCurrentStateAsync() {
        return new Promise(async (resolve, reject) => {
            try {
                let group = await this.controller.GetGroupAsync(this.context.groupNumber);
                this.context.brightness = group.Intensity;
                this.context.isOn = this.context.brightness > 0;
                resolve();
            }
            catch (err) {
                this.log.error(`${this.accessory.displayName} getCurrentStateAsync error: ${err}`);
                reject(err);
            }
            ;
        });
    }
    // this method used for callbacks
    callbackBrightness(intensity) {
        if (intensity !== this.context.brightness) {
            this.context.brightness = intensity;
            this.context.isOn = intensity > 0;
            this.log.debug(`${this.accessory.displayName} updated isOn to ${intensity > 0} and brightness ${intensity}.`);
            this.service.updateCharacteristic(this.platform.Characteristic.On, intensity > 0);
            this.service.updateCharacteristic(this.platform.Characteristic.Brightness, intensity);
        }
    }
}
exports.ZD_Light = ZD_Light;
var ILightType;
(function (ILightType) {
    ILightType["ZD"] = "ZD";
    ILightType["ZDC"] = "ZDC";
    ILightType["THEME"] = "Theme";
})(ILightType = exports.ILightType || (exports.ILightType = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWkRfTGlnaHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGlnaHRzL1pEX0xpZ2h0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUtBLE1BQWEsUUFBUTtJQU9qQixZQUFZLFFBQXVCLEVBQUUsU0FBNEI7UUFDN0QsSUFBSSxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQztRQUN4QixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBbUIsQ0FBQztRQUNsRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBQ0QsV0FBVztRQUNQLCtGQUErRjtRQUMvRix1Q0FBdUM7UUFFdkMsSUFBSTtZQUVBLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDO2lCQUNwRSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsT0FBTyxDQUFDO2lCQUNyRSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7aUJBQ3hFLGlCQUFpQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRW5GLElBQUksQ0FBQyxP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Q0FBQyxDQUFDO1lBQ2xGLElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1NBQ3pGO0lBQ0wsQ0FBQztDQUNKO0FBN0tELDRCQTZLQztBQUVELElBQVksVUFFWDtBQUZELFdBQVksVUFBVTtJQUNsQix1QkFBUyxDQUFBO0lBQUUseUJBQVcsQ0FBQTtJQUFFLDZCQUFlLENBQUE7QUFDM0MsQ0FBQyxFQUZXLFVBQVUsR0FBVixrQkFBVSxLQUFWLGtCQUFVLFFBRXJCIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBTZXJ2aWNlLCBQbGF0Zm9ybUFjY2Vzc29yeSwgQ2hhcmFjdGVyaXN0aWNWYWx1ZSwgQ2hhcmFjdGVyaXN0aWNTZXRDYWxsYmFjaywgQ2hhcmFjdGVyaXN0aWNHZXRDYWxsYmFjaywgTG9nZ2VyLCBIQVBTdGF0dXMgfSBmcm9tICdob21lYnJpZGdlJztcbmltcG9ydCB7IElDb250ZXh0LCBMdXhvclBsYXRmb3JtIH0gZnJvbSAnLi4vTHV4b3JQbGF0Zm9ybSc7XG5pbXBvcnQgeyBCYXNlQ29udHJvbGxlciB9IGZyb20gJy4uL2NvbnRyb2xsZXIvQmFzZUNvbnRyb2xsZXInO1xuXG5leHBvcnQgY2xhc3MgWkRfTGlnaHQge1xuICAgIHByb3RlY3RlZCBhY2Nlc3Nvcnk6IFBsYXRmb3JtQWNjZXNzb3J5O1xuICAgIHByb3RlY3RlZCBsb2c6IExvZ2dlcjtcbiAgICBwcm90ZWN0ZWQgc2VydmljZTogU2VydmljZTtcbiAgICBwcm90ZWN0ZWQgY29udHJvbGxlcjogQmFzZUNvbnRyb2xsZXI7XG4gICAgcHJvdGVjdGVkIHBsYXRmb3JtOiBMdXhvclBsYXRmb3JtO1xuICAgIHByb3RlY3RlZCBjb250ZXh0OiBJQ29udGV4dDtcbiAgICBjb25zdHJ1Y3RvcihwbGF0Zm9ybTogTHV4b3JQbGF0Zm9ybSwgYWNjZXNzb3J5OiBQbGF0Zm9ybUFjY2Vzc29yeSkge1xuICAgICAgICB0aGlzLmNvbnRyb2xsZXIgPSBwbGF0Zm9ybS5jb250cm9sbGVyO1xuICAgICAgICB0aGlzLmFjY2Vzc29yeSA9IGFjY2Vzc29yeTtcbiAgICAgICAgdGhpcy5sb2cgPSBwbGF0Zm9ybS5sb2c7XG4gICAgICAgIHRoaXMucGxhdGZvcm0gPSBwbGF0Zm9ybTtcbiAgICAgICAgdGhpcy5jb250ZXh0ID0gdGhpcy5hY2Nlc3NvcnkuY29udGV4dCBhcyBJQ29udGV4dDtcbiAgICAgICAgdGhpcy5sb2cuaW5mbyhgSW5pdGlhbGl6aW5nICR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9LmApO1xuICAgICAgICB0aGlzLnNldFNlcnZpY2VzKCk7XG4gICAgfVxuICAgIHNldFNlcnZpY2VzKCkge1xuICAgICAgICAvLyBNYWtlIHN1cmUgeW91IHByb3ZpZGVkIGEgbmFtZSBmb3Igc2VydmljZSBvdGhlcndpc2UgaXQgbWF5IG5vdCB2aXNpYmxlIGluIHNvbWUgSG9tZUtpdCBhcHBzLlxuICAgICAgICAvLyBpZiAodGhpcy5jb250ZXh0LnN0YXR1cyA9PT0gJ25ldycpIHtcblxuICAgICAgICB0cnkge1xuXG4gICAgICAgICAgICB0aGlzLmFjY2Vzc29yeS5nZXRTZXJ2aWNlKHRoaXMucGxhdGZvcm0uU2VydmljZS5BY2Nlc3NvcnlJbmZvcm1hdGlvbilcbiAgICAgICAgICAgIC5zZXRDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLk1hbnVmYWN0dXJlciwgXCJMdXhvclwiKVxuICAgICAgICAgICAgLnNldENoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuTW9kZWwsIHRoaXMuY29udGV4dC50eXBlKVxuICAgICAgICAgICAgLnNldENoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuU2VyaWFsTnVtYmVyLCB0aGlzLmFjY2Vzc29yeS5VVUlEKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlID0gdGhpcy5hY2Nlc3NvcnkuZ2V0U2VydmljZSh0aGlzLnBsYXRmb3JtLlNlcnZpY2UuTGlnaHRidWxiKSB8fCB0aGlzLmFjY2Vzc29yeS5hZGRTZXJ2aWNlKHRoaXMucGxhdGZvcm0uU2VydmljZS5MaWdodGJ1bGIpO1xuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLnNldENoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuTmFtZSwgdGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWUpO1xuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLmdldENoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuT24pXG4gICAgICAgICAgICAub24oJ2dldCcsIHRoaXMuZ2V0T24uYmluZCh0aGlzKSlcbiAgICAgICAgICAgIC5vbignc2V0JywgdGhpcy5zZXRPbi5iaW5kKHRoaXMpKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLmdldENoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuQnJpZ2h0bmVzcylcbiAgICAgICAgICAgIC5vbignc2V0JywgdGhpcy5zZXRCcmlnaHRuZXNzLmJpbmQodGhpcykpXG4gICAgICAgICAgICAub24oJ2dldCcsIHRoaXMuZ2V0QnJpZ2h0bmVzcy5iaW5kKHRoaXMpKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0YXR1cyA9ICdjdXJyZW50JztcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy5nZXRDdXJyZW50U3RhdGVBc3luYygpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldENoYXJhY3RlcmlzdGljcygpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2goZXJyKXtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgJHt0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZX0gc2V0U2VydmljZXMgZXJyb3I6ICR7ZXJyfWApXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycil7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgc2V0U2VydmljZXMgJHtlcnJ9YClcbiAgICAgICAgfVxuXG5cbiAgICAgICAgdGhpcy5hY2Nlc3Nvcnkub24oJ2lkZW50aWZ5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sb2cuaW5mbyhgSWRlbnRpZnlpbmcgJHt0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZX0uICBMaWdodHMgd2lsbCBmbGFzaCB0aHJpY2UuYCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmlsbHVtaW5hdGVHcm91cEFzeW5jKDEwMCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnNsZWVwKDMwMDApO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5pbGx1bWluYXRlR3JvdXBBc3luYygwKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2xlZXAoMzAwMCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmlsbHVtaW5hdGVHcm91cEFzeW5jKDEwMCk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnNsZWVwKDMwMDApXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmlsbHVtaW5hdGVHcm91cEFzeW5jKDApO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5jb250cm9sbGVyLnJlZ2lzdGVyQ2FsbGJhY2sodGhpcy5hY2Nlc3NvcnkuVVVJRCwgdGhpcy5jb250ZXh0LnR5cGUsIHRoaXMuY29udGV4dC5ncm91cE51bWJlciwgdGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5CcmlnaHRuZXNzLCB0aGlzLmNhbGxiYWNrQnJpZ2h0bmVzcy5iaW5kKHRoaXMpKTtcbiAgICB9XG4gICAgYXN5bmMgc2xlZXAobXMpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpO1xuICAgIH1cbiAgICBnZXRPbihjYWxsYmFjazogQ2hhcmFjdGVyaXN0aWNHZXRDYWxsYmFjayk6IHZvaWQge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gdGhpcy5sb2cuZGVidWcoXCJHZXR0aW5nIHBvd2VyIHN0YXRlIGZvcjogXCIsIHRoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lKTtcbiAgICAgICAgICAgIHRoaXMuZ2V0Q3VycmVudFN0YXRlQXN5bmMoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0aGlzLmNvbnRleHQuaXNPbik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgJHt0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZX0gZXJyb3I6ICR7ZXJyfWApXG4gICAgICAgICAgICB0aGlzLmNvbnRleHQuaXNPbiA9IGZhbHNlO1xuICAgICAgICAgICAgY2FsbGJhY2soSEFQU3RhdHVzLk5PVF9BTExPV0VEX0lOX0NVUlJFTlRfU1RBVEUsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBzZXRPbihkZXNpcmVkU3RhdGU6IGJvb2xlYW4sIGNhbGxiYWNrOiBDaGFyYWN0ZXJpc3RpY1NldENhbGxiYWNrKTogdm9pZCB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jb250ZXh0LmlzT24gPT09IGRlc2lyZWRTdGF0ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdOb3QgY2hhbmdpbmcgcG93ZXIgdG8gJXMgYmVjYXVzZSBpdCBpcyBhbHJlYWR5ICVzJywgZGVzaXJlZFN0YXRlID8gJ09uJyA6ICdPZmYnLCB0aGlzLmNvbnRleHQuaXNPbiA/ICdPbicgOiAnT2ZmJyk7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuaWxsdW1pbmF0ZUdyb3VwQXN5bmMoZGVzaXJlZFN0YXRlID8gdGhpcy5jb250ZXh0LmJyaWdodG5lc3MgfHwgMTAwIDogMCkudGhlbigoKSA9PiBjYWxsYmFjayhudWxsKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYCR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9IHNldE9uIGVycm9yOiAke2Vycn1gKVxuICAgICAgICAgICAgY2FsbGJhY2soSEFQU3RhdHVzLk5PVF9BTExPV0VEX0lOX0NVUlJFTlRfU1RBVEUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGdldEJyaWdodG5lc3MoY2FsbGJhY2s6IENoYXJhY3RlcmlzdGljR2V0Q2FsbGJhY2spOiB2b2lkIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMuZ2V0Q3VycmVudFN0YXRlQXN5bmMoKS50aGVuKCgpID0+IHsgY2FsbGJhY2sobnVsbCwgdGhpcy5jb250ZXh0LmJyaWdodG5lc3MpOyB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgJHt0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZX0gZ2V0QnJpZ2h0bmVzcyBlcnJvcjogJHtlcnJ9YClcbiAgICAgICAgICAgIGNhbGxiYWNrKEhBUFN0YXR1cy5OT1RfQUxMT1dFRF9JTl9DVVJSRU5UX1NUQVRFLCBmYWxzZSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgc2V0QnJpZ2h0bmVzcyhkZXNpcmVkQnJpZ2h0bmVzczogbnVtYmVyLCBjYWxsYmFjazogQ2hhcmFjdGVyaXN0aWNTZXRDYWxsYmFjayk6IHZvaWQge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKHRoaXMuY29udGV4dC5icmlnaHRuZXNzID09PSBkZXNpcmVkQnJpZ2h0bmVzcykge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdOb3QgY2hhbmdpbmcgYnJpZ2h0bmVzcyB0byAlcyBiZWNhdXNlIGl0IGlzIGFscmVhZHkgJXMnLCBkZXNpcmVkQnJpZ2h0bmVzcywgdGhpcy5jb250ZXh0LmJyaWdodG5lc3MpO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmlsbHVtaW5hdGVHcm91cEFzeW5jKGRlc2lyZWRCcmlnaHRuZXNzKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYCR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9IHNldEJyaWdodG5lc3MgZXJyb3I6ICR7ZXJyfWApXG4gICAgICAgICAgICBjYWxsYmFjayhIQVBTdGF0dXMuTk9UX0FMTE9XRURfSU5fQ1VSUkVOVF9TVEFURSwgZmFsc2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgaWxsdW1pbmF0ZUdyb3VwQXN5bmMoZGVzaXJlZEludGVuc2l0eTogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyhyZXNvbHZlLCByZWplY3QpPT57XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nLmluZm8oYCR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9IHR1cm5pbmcgJHtkZXNpcmVkSW50ZW5zaXR5ID4gMCA/ICdvbicgOiAnb2ZmJ30gd2l0aCBicmlnaHRuZXNzICR7ZGVzaXJlZEludGVuc2l0eX1gKTtcbiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgdGhpcy5jb250cm9sbGVyLklsbHVtaW5hdGVHcm91cEFzeW5jKHRoaXMuY29udGV4dC5ncm91cE51bWJlciwgZGVzaXJlZEludGVuc2l0eSk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5TdGF0dXNTdHIgPT09ICdPaycpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmJyaWdodG5lc3MgPSBkZXNpcmVkSW50ZW5zaXR5O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuaXNPbiA9IHRoaXMuY29udGV4dC5icmlnaHRuZXNzID4gMDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLnVwZGF0ZUNoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuT24sIGRlc2lyZWRJbnRlbnNpdHkgPiAwKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLnVwZGF0ZUNoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuQnJpZ2h0bmVzcywgZGVzaXJlZEludGVuc2l0eSk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGAke3RoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lfSByZXR1cm5lZCAke3Jlc3VsdC5TdGF0dXNTdHJ9IHRyeWluZyB0byBzZXQgaW50ZW5zaXR5ICR7ZGVzaXJlZEludGVuc2l0eX0uYClcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGAke3RoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lfSBpbGx1bWluYXRlR3JvdXBBc3luYyBlcnJvcjogJHtlcnJ9YClcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgICAgIH1cbiAgICBzZXRDaGFyYWN0ZXJpc3RpY3MoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc2VydmljZS51cGRhdGVDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLk9uLCB0eXBlb2YgdGhpcy5jb250ZXh0LmlzT24gIT09ICd1bmRlZmluZWQnID8gdGhpcy5jb250ZXh0LmlzT24gOiBmYWxzZSk7XG4gICAgICAgIHRoaXMuc2VydmljZS51cGRhdGVDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLkJyaWdodG5lc3MsIHR5cGVvZiB0aGlzLmNvbnRleHQuYnJpZ2h0bmVzcyAhPT0gJ3VuZGVmaW5lZCcgPyB0aGlzLmNvbnRleHQuYnJpZ2h0bmVzcyA6IDApO1xuICAgIH1cbiAgICAvLyB0aGlzIG1ldGhvZCB1c2VkIGZvciBldmVudCBoYW5kbGluZ1xuICAgIGFzeW5jIGdldEN1cnJlbnRTdGF0ZUFzeW5jKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBsZXQgZ3JvdXAgPSBhd2FpdCB0aGlzLmNvbnRyb2xsZXIuR2V0R3JvdXBBc3luYyh0aGlzLmNvbnRleHQuZ3JvdXBOdW1iZXIpO1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5icmlnaHRuZXNzID0gZ3JvdXAuSW50ZW5zaXR5O1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5pc09uID0gdGhpcy5jb250ZXh0LmJyaWdodG5lc3MgPiAwO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgJHt0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZX0gZ2V0Q3VycmVudFN0YXRlQXN5bmMgZXJyb3I6ICR7ZXJyfWApXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgfVxuICAgIC8vIHRoaXMgbWV0aG9kIHVzZWQgZm9yIGNhbGxiYWNrc1xuICAgIGNhbGxiYWNrQnJpZ2h0bmVzcyhpbnRlbnNpdHk6IG51bWJlcik6IHZvaWQge1xuXG4gICAgICAgIGlmIChpbnRlbnNpdHkgIT09IHRoaXMuY29udGV4dC5icmlnaHRuZXNzKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRleHQuYnJpZ2h0bmVzcyA9IGludGVuc2l0eTtcbiAgICAgICAgICAgIHRoaXMuY29udGV4dC5pc09uID0gaW50ZW5zaXR5ID4gMDtcbiAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKGAke3RoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lfSB1cGRhdGVkIGlzT24gdG8gJHtpbnRlbnNpdHkgPiAwfSBhbmQgYnJpZ2h0bmVzcyAke2ludGVuc2l0eX0uYCk7XG4gICAgICAgICAgICB0aGlzLnNlcnZpY2UudXBkYXRlQ2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5PbiwgaW50ZW5zaXR5ID4gMCk7XG4gICAgICAgICAgICB0aGlzLnNlcnZpY2UudXBkYXRlQ2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5CcmlnaHRuZXNzLCBpbnRlbnNpdHkpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgZW51bSBJTGlnaHRUeXBlIHtcbiAgICBaRCA9ICdaRCcsIFpEQyA9ICdaREMnLCBUSEVNRSA9ICdUaGVtZSdcbn0iXX0=