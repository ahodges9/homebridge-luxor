"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ZDC_Light = void 0;
// var desiredHue = -1,
//     desiredSaturation = -1; // HomeKit calls Hue/Saturation independently but we need both of them
// var desiredHueSatTimer; // timer to clear desired values if we don't get both
const ZD_Light_1 = require("./ZD_Light");
class ZDC_Light extends ZD_Light_1.ZD_Light {
    constructor(platform, accessory) {
        super(platform, accessory);
    }
    setServices() {
        super.setServices();
        this.service.getCharacteristic(this.platform.Characteristic.Saturation)
            .on('get', this.getSaturation.bind(this))
            .on('set', this.setSaturation.bind(this));
        this.service.getCharacteristic(this.platform.Characteristic.Hue)
            .on('get', this.getHue.bind(this))
            .on('set', this.setHue.bind(this));
        this.controller.registerCallback(this.accessory.UUID, this.context.type, this.context.groupNumber, this.platform.Characteristic.Hue, this.callbackHue.bind(this));
        this.controller.registerCallback(this.accessory.UUID, this.context.type, this.context.groupNumber, this.platform.Characteristic.Saturation, this.callbackSat.bind(this));
    }
    getHue(callback) {
        try {
            this.controller.GetColorAsync(this.context.color).then(colors => {
                this.context.hue = colors.Hue;
                // shouldn't need this
                // this.service.updateCharacteristic(this.platform.Characteristic.Hue, colors.Hue);
                // this.service.updateCharacteristic(this.platform.Characteristic.Saturation, colors.Sat);
                callback(null, this.context.hue);
            });
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} getHue error: ${err}`);
            callback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */, false);
        }
    }
    ;
    setHue(desiredHue, callback) {
        this.desiredHue = desiredHue;
        this.hueCallback = callback;
        if (typeof this.satCallback !== 'undefined')
            setTimeout(() => { this.colorListSetCallbacks(); }, 100);
    }
    ;
    getSaturation(callback) {
        try {
            this.controller.GetColorAsync(this.context.color).then(colors => {
                this.context.saturation = colors.Sat;
                // shouldn't need this
                // this.service.updateCharacteristic(this.platform.Characteristic.Hue, colors.Hue);
                // this.service.updateCharacteristic(this.platform.Characteristic.Saturation, colors.Sat);
                callback(null, this.context.saturation);
            });
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} getSaturation error: ${err}`);
            callback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */, false);
        }
    }
    ;
    setSaturation(desiredSaturation, callback) {
        this.desiredSaturation = desiredSaturation;
        this.satCallback = callback;
        if (typeof this.hueCallback !== 'undefined')
            setTimeout(() => { this.colorListSetCallbacks(); }, 200);
    }
    ;
    async colorListSet() {
        try {
            let status = await this.controller.ColorListSetAsync(this.context.color, this.desiredHue, this.desiredSaturation);
            if (status.Status > 0) {
                this.context.hue = this.desiredHue;
                this.context.saturation = this.desiredSaturation;
                this.desiredHue = undefined;
                this.desiredSaturation = undefined;
            }
            return status;
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} colorListSet error: ${err}`);
        }
        ;
    }
    colorListSetCallbacks() {
        try {
            this.colorListSet().then(() => {
                if (typeof this.satCallback === 'function')
                    this.satCallback(null);
                this.satCallback = undefined;
                if (typeof this.hueCallback === 'function')
                    this.hueCallback(null);
                this.hueCallback = undefined;
            });
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} colorListSetCallbacks error: ${err}`);
            if (typeof this.satCallback === 'function')
                this.satCallback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */);
            this.satCallback = undefined;
            if (typeof this.hueCallback === 'function')
                this.hueCallback(-70412 /* NOT_ALLOWED_IN_CURRENT_STATE */);
            this.hueCallback = undefined;
        }
    }
    async groupListEditAsync(currentColor) {
        try {
            if (this.context.color === 0)
                return;
            // if the color paletto CXXX was change outside homebridge, but the user selects to set the color/brightness then make sure we assign the right color.
            var desiredColor = 250 - this.context.groupNumber + 1;
            if (currentColor !== desiredColor) {
                this.log.debug('%s color assignment was changed outside of HomeKit.  Changing to %s', this.accessory.displayName, desiredColor);
                this.context.color = desiredColor;
                await this.controller.GroupListEditAsync(this.accessory.displayName, this.context.groupNumber, this.context.color);
            }
            return Promise.resolve();
        }
        catch (err) {
            this.log.error(`${this.accessory.displayName} groupListEdit error: ${err}`);
            return Promise.reject();
        }
        ;
    }
    ;
    // this method used for event handling
    async getCurrentStateAsync() {
        return new Promise(async (resolve, reject) => {
            try {
                let group = await this.controller.GetGroupAsync(this.context.groupNumber);
                this.context.brightness = group.Intensity;
                this.context.isOn = this.context.brightness > 0;
                if (this.context.independentColors)
                    await this.groupListEditAsync(group.Color);
                else {
                    this.context.color = group.Color;
                }
                let colors = await this.controller.GetColorAsync(this.context.color);
                if (colors.Hue !== this.context.hue || colors.Sat !== this.context.saturation) {
                    this.desiredHue = colors.Hue;
                    this.desiredSaturation = colors.Sat;
                    await this.colorListSet();
                }
                else {
                    this.context.hue = colors.Hue;
                    this.context.saturation = colors.Sat;
                }
                resolve();
            }
            catch (err) {
                this.log.error(`${this.accessory.displayName} getCurrentStateAsync error: ${err}`);
                reject(err);
            }
        });
    }
    setCharacteristics() {
        this.service.updateCharacteristic(this.platform.Characteristic.On, typeof this.context.isOn !== 'undefined' ? this.context.isOn : false);
        this.service.updateCharacteristic(this.platform.Characteristic.Brightness, typeof this.context.brightness !== 'undefined' ? this.context.brightness : 0);
        this.service.updateCharacteristic(this.platform.Characteristic.Hue, typeof this.context.hue !== 'undefined' ? this.context.hue : 0);
        this.service.updateCharacteristic(this.platform.Characteristic.Saturation, typeof this.context.saturation !== 'undefined' ? this.context.saturation : 0);
    }
    // this method used for callbacks
    callbackHue(hue) {
        if (hue !== this.context.hue && this.context.color !== 0) {
            this.context.hue = hue;
            // this.log.debug(`${this.accessory.displayName} updated hue to ${hue}.`);
            this.service.updateCharacteristic(this.platform.Characteristic.Hue, hue);
        }
    }
    ;
    callbackSat(saturation) {
        if (saturation !== this.context.saturation && this.context.color !== 0) {
            this.context.saturation = saturation;
            // this.log.debug(`${this.accessory.displayName} updated saturation to ${saturation}.`);
            this.service.updateCharacteristic(this.platform.Characteristic.Saturation, saturation);
        }
    }
    ;
}
exports.ZDC_Light = ZDC_Light;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWkRDX0xpZ2h0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xpZ2h0cy9aRENfTGlnaHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsdUJBQXVCO0FBQ3ZCLHFHQUFxRztBQUNyRyxnRkFBZ0Y7QUFDaEYseUNBQXNDO0FBTXRDLE1BQWEsU0FBVSxTQUFRLG1CQUFRO0lBS25DLFlBQVksUUFBdUIsRUFBRSxTQUE0QjtRQUM3RCxLQUFLLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRCxXQUFXO1FBQ1AsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXBCLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDO2FBQ2xFLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDeEMsRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRTlDLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDO2FBQzNELEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDakMsRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRXZDLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsSUFB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LENBQUM7SUFBQSxDQUFDO0NBQ0w7QUFuS0QsOEJBbUtDIiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyB2YXIgZGVzaXJlZEh1ZSA9IC0xLFxuLy8gICAgIGRlc2lyZWRTYXR1cmF0aW9uID0gLTE7IC8vIEhvbWVLaXQgY2FsbHMgSHVlL1NhdHVyYXRpb24gaW5kZXBlbmRlbnRseSBidXQgd2UgbmVlZCBib3RoIG9mIHRoZW1cbi8vIHZhciBkZXNpcmVkSHVlU2F0VGltZXI7IC8vIHRpbWVyIHRvIGNsZWFyIGRlc2lyZWQgdmFsdWVzIGlmIHdlIGRvbid0IGdldCBib3RoXG5pbXBvcnQgeyBaRF9MaWdodCB9IGZyb20gJy4vWkRfTGlnaHQnO1xuXG5pbXBvcnQgeyBTZXJ2aWNlLCBQbGF0Zm9ybUFjY2Vzc29yeSwgQ2hhcmFjdGVyaXN0aWNWYWx1ZSwgQ2hhcmFjdGVyaXN0aWNTZXRDYWxsYmFjaywgQ2hhcmFjdGVyaXN0aWNHZXRDYWxsYmFjaywgSGFwU3RhdHVzRXJyb3IsIEhBUFN0YXR1cyB9IGZyb20gJ2hvbWVicmlkZ2UnO1xuaW1wb3J0IHsgSUNvbnRleHQsIEx1eG9yUGxhdGZvcm0gfSBmcm9tICcuLi9MdXhvclBsYXRmb3JtJztcbmltcG9ydCB7IElTdGF0dXMgfSBmcm9tICcuLi9jb250cm9sbGVyL0Jhc2VDb250cm9sbGVyJztcblxuZXhwb3J0IGNsYXNzIFpEQ19MaWdodCBleHRlbmRzIFpEX0xpZ2h0IHtcbiAgICBwcml2YXRlIGRlc2lyZWRIdWU6IG51bWJlcjtcbiAgICBwcml2YXRlIGRlc2lyZWRTYXR1cmF0aW9uOiBudW1iZXJcbiAgICBwcml2YXRlIGh1ZUNhbGxiYWNrOiBDaGFyYWN0ZXJpc3RpY1NldENhbGxiYWNrO1xuICAgIHByaXZhdGUgc2F0Q2FsbGJhY2s6IENoYXJhY3RlcmlzdGljU2V0Q2FsbGJhY2s7XG4gICAgY29uc3RydWN0b3IocGxhdGZvcm06IEx1eG9yUGxhdGZvcm0sIGFjY2Vzc29yeTogUGxhdGZvcm1BY2Nlc3NvcnkpIHtcbiAgICAgICAgc3VwZXIocGxhdGZvcm0sIGFjY2Vzc29yeSk7XG4gICAgfVxuXG4gICAgc2V0U2VydmljZXMoKSB7XG4gICAgICAgIHN1cGVyLnNldFNlcnZpY2VzKCk7XG5cbiAgICAgICAgdGhpcy5zZXJ2aWNlLmdldENoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuU2F0dXJhdGlvbilcbiAgICAgICAgICAgIC5vbignZ2V0JywgdGhpcy5nZXRTYXR1cmF0aW9uLmJpbmQodGhpcykpXG4gICAgICAgICAgICAub24oJ3NldCcsIHRoaXMuc2V0U2F0dXJhdGlvbi5iaW5kKHRoaXMpKTtcblxuICAgICAgICB0aGlzLnNlcnZpY2UuZ2V0Q2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5IdWUpXG4gICAgICAgICAgICAub24oJ2dldCcsIHRoaXMuZ2V0SHVlLmJpbmQodGhpcykpXG4gICAgICAgICAgICAub24oJ3NldCcsIHRoaXMuc2V0SHVlLmJpbmQodGhpcykpO1xuXG4gICAgICAgIHRoaXMuY29udHJvbGxlci5yZWdpc3RlckNhbGxiYWNrKHRoaXMuYWNjZXNzb3J5LlVVSUQsIHRoaXMuY29udGV4dC50eXBlLCB0aGlzLmNvbnRleHQuZ3JvdXBOdW1iZXIsIHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuSHVlLCB0aGlzLmNhbGxiYWNrSHVlLmJpbmQodGhpcykpO1xuICAgICAgICB0aGlzLmNvbnRyb2xsZXIucmVnaXN0ZXJDYWxsYmFjayh0aGlzLmFjY2Vzc29yeS5VVUlELCB0aGlzLmNvbnRleHQudHlwZSwgdGhpcy5jb250ZXh0Lmdyb3VwTnVtYmVyLCB0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLlNhdHVyYXRpb24sIHRoaXMuY2FsbGJhY2tTYXQuYmluZCh0aGlzKSk7XG4gICAgfVxuXG4gICAgZ2V0SHVlKGNhbGxiYWNrOiBDaGFyYWN0ZXJpc3RpY0dldENhbGxiYWNrKTogdm9pZCB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuR2V0Q29sb3JBc3luYyh0aGlzLmNvbnRleHQuY29sb3IpLnRoZW4oY29sb3JzID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuaHVlID0gY29sb3JzLkh1ZTtcbiAgICAgICAgICAgICAgICAvLyBzaG91bGRuJ3QgbmVlZCB0aGlzXG4gICAgICAgICAgICAgICAgLy8gdGhpcy5zZXJ2aWNlLnVwZGF0ZUNoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuSHVlLCBjb2xvcnMuSHVlKTtcbiAgICAgICAgICAgICAgICAvLyB0aGlzLnNlcnZpY2UudXBkYXRlQ2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5TYXR1cmF0aW9uLCBjb2xvcnMuU2F0KTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB0aGlzLmNvbnRleHQuaHVlKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYCR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9IGdldEh1ZSBlcnJvcjogJHtlcnJ9YClcbiAgICAgICAgICAgIGNhbGxiYWNrKEhBUFN0YXR1cy5OT1RfQUxMT1dFRF9JTl9DVVJSRU5UX1NUQVRFLCBmYWxzZSk7XG4gICAgICAgIH1cblxuICAgIH07XG4gICAgc2V0SHVlKGRlc2lyZWRIdWU6IG51bWJlciwgY2FsbGJhY2s6IENoYXJhY3RlcmlzdGljU2V0Q2FsbGJhY2spOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kZXNpcmVkSHVlID0gZGVzaXJlZEh1ZTtcbiAgICAgICAgdGhpcy5odWVDYWxsYmFjayA9IGNhbGxiYWNrO1xuICAgICAgICBpZiAodHlwZW9mIHRoaXMuc2F0Q2FsbGJhY2sgIT09ICd1bmRlZmluZWQnKSBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy5jb2xvckxpc3RTZXRDYWxsYmFja3MoKSB9LCAxMDApO1xuICAgIH07XG4gICAgXG4gICAgZ2V0U2F0dXJhdGlvbihjYWxsYmFjazogQ2hhcmFjdGVyaXN0aWNHZXRDYWxsYmFjayk6IHZvaWQge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLkdldENvbG9yQXN5bmModGhpcy5jb250ZXh0LmNvbG9yKS50aGVuKGNvbG9ycyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnNhdHVyYXRpb24gPSBjb2xvcnMuU2F0O1xuICAgICAgICAgICAgICAgIC8vIHNob3VsZG4ndCBuZWVkIHRoaXNcbiAgICAgICAgICAgICAgICAvLyB0aGlzLnNlcnZpY2UudXBkYXRlQ2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5IdWUsIGNvbG9ycy5IdWUpO1xuICAgICAgICAgICAgICAgIC8vIHRoaXMuc2VydmljZS51cGRhdGVDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLlNhdHVyYXRpb24sIGNvbG9ycy5TYXQpO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHRoaXMuY29udGV4dC5zYXR1cmF0aW9uKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYCR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9IGdldFNhdHVyYXRpb24gZXJyb3I6ICR7ZXJyfWApXG4gICAgICAgICAgICBjYWxsYmFjayhIQVBTdGF0dXMuTk9UX0FMTE9XRURfSU5fQ1VSUkVOVF9TVEFURSwgZmFsc2UpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBzZXRTYXR1cmF0aW9uKGRlc2lyZWRTYXR1cmF0aW9uOiBudW1iZXIsIGNhbGxiYWNrOiBDaGFyYWN0ZXJpc3RpY1NldENhbGxiYWNrKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZGVzaXJlZFNhdHVyYXRpb24gPSBkZXNpcmVkU2F0dXJhdGlvbjtcbiAgICAgICAgdGhpcy5zYXRDYWxsYmFjayA9IGNhbGxiYWNrO1xuICAgICAgICBpZiAodHlwZW9mIHRoaXMuaHVlQ2FsbGJhY2sgIT09ICd1bmRlZmluZWQnKSBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy5jb2xvckxpc3RTZXRDYWxsYmFja3MoKSB9LCAyMDApO1xuICAgIH07XG4gICAgYXN5bmMgY29sb3JMaXN0U2V0KCk6IFByb21pc2U8SVN0YXR1cz4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IHN0YXR1cyA9IGF3YWl0IHRoaXMuY29udHJvbGxlci5Db2xvckxpc3RTZXRBc3luYyh0aGlzLmNvbnRleHQuY29sb3IsIHRoaXMuZGVzaXJlZEh1ZSwgdGhpcy5kZXNpcmVkU2F0dXJhdGlvbik7XG4gICAgICAgICAgICBpZiAoc3RhdHVzLlN0YXR1cyA+IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuaHVlID0gdGhpcy5kZXNpcmVkSHVlO1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5zYXR1cmF0aW9uID0gdGhpcy5kZXNpcmVkU2F0dXJhdGlvbjtcbiAgICAgICAgICAgICAgICB0aGlzLmRlc2lyZWRIdWUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgdGhpcy5kZXNpcmVkU2F0dXJhdGlvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBzdGF0dXM7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYCR7dGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWV9IGNvbG9yTGlzdFNldCBlcnJvcjogJHtlcnJ9YClcbiAgICAgICAgfTtcbiAgICB9XG4gICAgY29sb3JMaXN0U2V0Q2FsbGJhY2tzKCk6IHZvaWQge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy5jb2xvckxpc3RTZXQoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuc2F0Q2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHRoaXMuc2F0Q2FsbGJhY2sobnVsbCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zYXRDYWxsYmFjayA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuaHVlQ2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHRoaXMuaHVlQ2FsbGJhY2sobnVsbCk7XG4gICAgICAgICAgICAgICAgdGhpcy5odWVDYWxsYmFjayA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGAke3RoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lfSBjb2xvckxpc3RTZXRDYWxsYmFja3MgZXJyb3I6ICR7ZXJyfWApXG4gICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuc2F0Q2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHRoaXMuc2F0Q2FsbGJhY2soSEFQU3RhdHVzLk5PVF9BTExPV0VEX0lOX0NVUlJFTlRfU1RBVEUpO1xuICAgICAgICAgICAgdGhpcy5zYXRDYWxsYmFjayA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5odWVDYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgdGhpcy5odWVDYWxsYmFjayhIQVBTdGF0dXMuTk9UX0FMTE9XRURfSU5fQ1VSUkVOVF9TVEFURSk7XG4gICAgICAgICAgICB0aGlzLmh1ZUNhbGxiYWNrID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgfVxuICAgIGFzeW5jIGdyb3VwTGlzdEVkaXRBc3luYyhjdXJyZW50Q29sb3I6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKHRoaXMuY29udGV4dC5jb2xvciA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgLy8gaWYgdGhlIGNvbG9yIHBhbGV0dG8gQ1hYWCB3YXMgY2hhbmdlIG91dHNpZGUgaG9tZWJyaWRnZSwgYnV0IHRoZSB1c2VyIHNlbGVjdHMgdG8gc2V0IHRoZSBjb2xvci9icmlnaHRuZXNzIHRoZW4gbWFrZSBzdXJlIHdlIGFzc2lnbiB0aGUgcmlnaHQgY29sb3IuXG4gICAgICAgICAgICB2YXIgZGVzaXJlZENvbG9yID0gMjUwIC0gdGhpcy5jb250ZXh0Lmdyb3VwTnVtYmVyICsgMTtcbiAgICAgICAgICAgIGlmIChjdXJyZW50Q29sb3IgIT09IGRlc2lyZWRDb2xvcikge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCclcyBjb2xvciBhc3NpZ25tZW50IHdhcyBjaGFuZ2VkIG91dHNpZGUgb2YgSG9tZUtpdC4gIENoYW5naW5nIHRvICVzJywgdGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWUsIGRlc2lyZWRDb2xvcik7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmNvbG9yID0gZGVzaXJlZENvbG9yO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuY29udHJvbGxlci5Hcm91cExpc3RFZGl0QXN5bmModGhpcy5hY2Nlc3NvcnkuZGlzcGxheU5hbWUsIHRoaXMuY29udGV4dC5ncm91cE51bWJlciwgdGhpcy5jb250ZXh0LmNvbG9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgJHt0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZX0gZ3JvdXBMaXN0RWRpdCBlcnJvcjogJHtlcnJ9YCk7IHJldHVybiBQcm9taXNlLnJlamVjdCgpO1xuICAgICAgICB9O1xuICAgIH07XG5cbiAgICAvLyB0aGlzIG1ldGhvZCB1c2VkIGZvciBldmVudCBoYW5kbGluZ1xuICAgIGFzeW5jIGdldEN1cnJlbnRTdGF0ZUFzeW5jKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBsZXQgZ3JvdXAgPSBhd2FpdCB0aGlzLmNvbnRyb2xsZXIuR2V0R3JvdXBBc3luYyh0aGlzLmNvbnRleHQuZ3JvdXBOdW1iZXIpO1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5icmlnaHRuZXNzID0gZ3JvdXAuSW50ZW5zaXR5O1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5pc09uID0gdGhpcy5jb250ZXh0LmJyaWdodG5lc3MgPiAwO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbnRleHQuaW5kZXBlbmRlbnRDb2xvcnMpIGF3YWl0IHRoaXMuZ3JvdXBMaXN0RWRpdEFzeW5jKGdyb3VwLkNvbG9yKTtcbiAgICAgICAgICAgICAgICBlbHNlIHsgdGhpcy5jb250ZXh0LmNvbG9yID0gZ3JvdXAuQ29sb3I7IH1cbiAgICAgICAgICAgICAgICBsZXQgY29sb3JzID0gYXdhaXQgdGhpcy5jb250cm9sbGVyLkdldENvbG9yQXN5bmModGhpcy5jb250ZXh0LmNvbG9yKVxuICAgICAgICAgICAgICAgIGlmIChjb2xvcnMuSHVlICE9PSB0aGlzLmNvbnRleHQuaHVlIHx8IGNvbG9ycy5TYXQgIT09IHRoaXMuY29udGV4dC5zYXR1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVzaXJlZEh1ZSA9IGNvbG9ycy5IdWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVzaXJlZFNhdHVyYXRpb24gPSBjb2xvcnMuU2F0O1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNvbG9yTGlzdFNldCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0Lmh1ZSA9IGNvbG9ycy5IdWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5zYXR1cmF0aW9uID0gY29sb3JzLlNhdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGAke3RoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lfSBnZXRDdXJyZW50U3RhdGVBc3luYyBlcnJvcjogJHtlcnJ9YClcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9XG4gICAgc2V0Q2hhcmFjdGVyaXN0aWNzKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnNlcnZpY2UudXBkYXRlQ2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5PbiwgdHlwZW9mIHRoaXMuY29udGV4dC5pc09uICE9PSAndW5kZWZpbmVkJyA/IHRoaXMuY29udGV4dC5pc09uIDogZmFsc2UpO1xuICAgICAgICB0aGlzLnNlcnZpY2UudXBkYXRlQ2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5CcmlnaHRuZXNzLCB0eXBlb2YgdGhpcy5jb250ZXh0LmJyaWdodG5lc3MgIT09ICd1bmRlZmluZWQnID8gdGhpcy5jb250ZXh0LmJyaWdodG5lc3MgOiAwKTtcbiAgICAgICAgdGhpcy5zZXJ2aWNlLnVwZGF0ZUNoYXJhY3RlcmlzdGljKHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuSHVlLCB0eXBlb2YgdGhpcy5jb250ZXh0Lmh1ZSAhPT0gJ3VuZGVmaW5lZCcgPyB0aGlzLmNvbnRleHQuaHVlIDogMCk7XG4gICAgICAgIHRoaXMuc2VydmljZS51cGRhdGVDaGFyYWN0ZXJpc3RpYyh0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLlNhdHVyYXRpb24sIHR5cGVvZiB0aGlzLmNvbnRleHQuc2F0dXJhdGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyB0aGlzLmNvbnRleHQuc2F0dXJhdGlvbiA6IDApO1xuICAgIH1cbiAgICAvLyB0aGlzIG1ldGhvZCB1c2VkIGZvciBjYWxsYmFja3NcbiAgICBjYWxsYmFja0h1ZShodWU6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBpZiAoaHVlICE9PSB0aGlzLmNvbnRleHQuaHVlICYmIHRoaXMuY29udGV4dC5jb2xvciAhPT0gMCkge1xuICAgICAgICAgICAgdGhpcy5jb250ZXh0Lmh1ZSA9IGh1ZTtcbiAgICAgICAgICAgIC8vIHRoaXMubG9nLmRlYnVnKGAke3RoaXMuYWNjZXNzb3J5LmRpc3BsYXlOYW1lfSB1cGRhdGVkIGh1ZSB0byAke2h1ZX0uYCk7XG4gICAgICAgICAgICB0aGlzLnNlcnZpY2UudXBkYXRlQ2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5IdWUsIGh1ZSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGNhbGxiYWNrU2F0KHNhdHVyYXRpb246IG51bWJlcik6IHZvaWQge1xuICAgICAgICBpZiAoc2F0dXJhdGlvbiAhPT0gdGhpcy5jb250ZXh0LnNhdHVyYXRpb24gJiYgdGhpcy5jb250ZXh0LmNvbG9yICE9PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRleHQuc2F0dXJhdGlvbiA9IHNhdHVyYXRpb247XG4gICAgICAgICAgICAvLyB0aGlzLmxvZy5kZWJ1ZyhgJHt0aGlzLmFjY2Vzc29yeS5kaXNwbGF5TmFtZX0gdXBkYXRlZCBzYXR1cmF0aW9uIHRvICR7c2F0dXJhdGlvbn0uYCk7XG4gICAgICAgICAgICB0aGlzLnNlcnZpY2UudXBkYXRlQ2hhcmFjdGVyaXN0aWModGhpcy5wbGF0Zm9ybS5DaGFyYWN0ZXJpc3RpYy5TYXR1cmF0aW9uLCBzYXR1cmF0aW9uKTtcbiAgICAgICAgfVxuICAgIH07XG59Il19