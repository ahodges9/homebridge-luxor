"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.IControllerType = exports.BaseController = void 0;
const ZD_Light_1 = require("../lights/ZD_Light");
const Queue_1 = __importDefault(require("../Queue"));
const axios = require('axios').default;
class BaseController {
    constructor(data, log) {
        this.log = log;
        this.callbackList = [];
        this.GroupList = [];
        if (typeof data.ip === 'undefined') {
            this.log.debug(`Initializing base controller.`);
            return;
        }
        this.ip = data.ip;
        this.name = data.Controller;
        this.type = data.type;
        this.platform = data.platform;
        this.hideGroups = data.hideGroups;
        this.independentColors = data.independentColors;
        log.info(`Assigning ${this.type} Controller to IP ${this.ip}`);
        // this.updateLights();
        setTimeout(async () => { await this.pollController(); }, 30000);
    }
    getStatus(result) {
        switch (result) {
            case 0:
                return ('Ok'); //StatusOk
            case (1):
                return ('Unknown Method'); //StatusUnknownMethod
            case (101):
                return ('Unparseable Request'); //StatusUnparseableRequest
            case (102):
                return ('Invalid Request'); //StatusInvalidRequest
            case (151):
                return ('Color Value Out of Range');
            case (201):
                return ('Precondition Failed'); //StatusPreconditionFailed
            case (202):
                return ('Group Name In Use'); //StatusGroupNameInUse
            case (205):
                return ('Group Number In Use'); //StatusGroupNumberInUse
            case (241):
                return ('Item Does Not Exist'); //StatusThemeIndexOutOfRange
            case (242):
                return ('Bad Group Number'); //StatusThemeIndexOutOfRange
            case (243):
                return ('Theme Index Out Of Range'); //StatusThemeIndexOutOfRange
            case (251):
                return ('Bad Theme Index'); //StatusThemeIndexOutOfRange
            case (252):
                return ('Theme Changes Restricted'); //StatusThemeIndexOutOfRange
            default:
                return ('Unknown status');
        }
    }
    async doRequest(url, data) {
        return new Promise(async (resolve, reject) => {
            try {
                switch (url) {
                    case 'GroupListGet':
                        if (this.hideGroups)
                            return;
                        if (typeof this.cacheGroupList !== 'undefined' && Date.now() - this.cacheGroupList < 2000) {
                            resolve({ Status: 1, StatusStr: 'Cached', GroupList: this.GroupList });
                            return;
                        }
                        break;
                    case 'ThemeListGet':
                        if (typeof this.cacheThemeList !== 'undefined' && Date.now() - this.cacheThemeList < 2000) {
                            resolve({ Status: 1, StatusStr: 'Cached', ThemeList: this.ThemeList });
                            return;
                        }
                        break;
                    case 'ColorListGet':
                        if (typeof this.cacheColorList !== 'undefined' && Date.now() - this.cacheColorList < 2000) {
                            resolve({ Status: 1, StatusStr: 'Cached', ColorList: this.ColorList });
                            return;
                        }
                        break;
                }
                const response = await axios({
                    method: 'post',
                    url: 'http://' + this.ip + '/' + url + '.json',
                    data,
                    headers: {
                        'cache-control': 'no-cache'
                    },
                    timeout: 750
                });
                response.data.StatusStr = this.getStatus(response.data.Status);
                if (response.data.StatusStr !== 'Ok' || response.code === 'ETIMEOUT') {
                    this.log.error(`Controller ${this.name} responded with error ${response.data.StatusStr} to '${url}'`);
                    resolve({ Status: 1, StatusStr: 'Ok', GroupList: this.GroupList || [], ThemeList: this.ThemeList || [], ColorList: this.ColorList || [] });
                }
                else
                    resolve(response.data);
            }
            catch (err) {
                this.log.error(`Error communicating with controller ${this.name}. URL ${url}.json.\n\t${err}`);
                reject(err);
            }
        });
    }
    async sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    async IlluminateAllAsync() {
        return Queue_1.default.enqueue(async () => {
            let status = await this.doRequest('IlluminateAll');
            return status;
        });
    }
    async ExtinguishAllAsync() {
        return Queue_1.default.enqueue(async () => {
            let status = await this.doRequest('ExtinguishAll');
            return status;
        });
    }
    async GetGroupAsync(group) {
        if (this.hideGroups)
            return;
        return new Promise(async (resolve, reject) => {
            try {
                await this.GroupListGetAsync();
                for (let i in this.GroupList) {
                    if (this.GroupList[i].GroupNumber === group)
                        return resolve(this.GroupList[i]);
                }
                reject(`No Group Found in GroupGetAsync for group ${group}.\n${JSON.stringify(this.GroupList)}`);
            }
            catch (err) {
                reject(`Error with GetGroupAsync: ${err}`);
                this.log.error(err);
            }
        });
    }
    async GroupListGetAsync() {
        // Get the list of light groups from the controller
        if (typeof this.cacheGroupList !== 'undefined' && Date.now() - this.cacheGroupList < 2000) {
            return (this.GroupList);
        }
        return Queue_1.default.enqueue(async () => {
            let data = await this.doRequest('GroupListGet');
            if (data.Status === 0) {
                this.cacheGroupList = Date.now();
                this.processGroupListGet(data);
            }
            return this.GroupList;
        });
    }
    processGroupListGet(data) {
        // override with ZDC/ZDTWO
        this.GroupList = data.GroupList;
        for (let i in this.GroupList) {
            this.GroupList[i].type = ZD_Light_1.ILightType.ZD;
        }
    }
    async GroupListEditAsync(name, groupNumber, color) {
        // Same in ZDC/ZDTWO
        var requestData = JSON.stringify({
            'Name': name,
            'GroupNumber': groupNumber,
            'Color': color
        });
        return Queue_1.default.enqueue(async () => {
            let status = await this.doRequest('GroupListEdit', requestData);
            return status;
        });
        /*     let status = await this.queueRequest('GroupListEdit', requestData);
            return status; */
    }
    async ThemeListGetAsync() {
        if (typeof this.cacheThemeList !== 'undefined' && Date.now() - this.cacheThemeList < 2000) {
            return (this.ThemeList);
        }
        return Queue_1.default.enqueue(async () => {
            let data = await this.doRequest('ThemeListGet');
            if (data.Status === 0) {
                this.cacheThemeList = Date.now();
                this.processThemeListGet(data);
            }
            return this.ThemeList;
        });
    }
    processThemeListGet(data) {
        this.ThemeList = data.ThemeList;
        for (var i in this.ThemeList) {
            this.ThemeList[i].isOn = this.ThemeList[i].OnOff === 1;
            this.ThemeList[i].type = ZD_Light_1.ILightType.THEME;
        }
    }
    async GetThemeAsync(index) {
        return new Promise(async (resolve, reject) => {
            try {
                await this.ThemeListGetAsync();
                for (let i in this.ThemeList) {
                    if (this.ThemeList[i].ThemeIndex === index)
                        return resolve(this.ThemeList[i]);
                }
                reject(`No Theme Found in ThemeGetAsync for theme ${index}.\n${JSON.stringify(this.ThemeList)}`);
            }
            catch (err) {
                this.log.error(err);
                reject(`Error with GetThemeAsync ${err}`);
            }
        });
    }
    async IlluminateThemeAsync(themeIndex, onOff) {
        return Queue_1.default.enqueue(async () => {
            let status = await this.doRequest('IlluminateTheme', {
                'ThemeIndex': themeIndex,
                'OnOff': onOff
            });
            this.cacheThemeList = undefined;
            setTimeout(async () => { await this.updateLights(); }, 250);
            return status;
        });
    }
    async IlluminateGroupAsync(groupNumber, desiredIntensity) {
        return Queue_1.default.enqueue(async () => {
            let status = await this.doRequest('IlluminateGroup', {
                'GroupNumber': groupNumber,
                'Intensity': desiredIntensity
            });
            return status;
        });
    }
    async ColorListGetAsync() {
        return {};
    }
    async ColorListSetAsync(color, hue, saturation) {
        return {};
    }
    processColorListGet(data) {
        this.ColorList = data.ColorList;
    }
    ;
    async GetColorAsync(color) { return {}; }
    registerCallback(UUID, type, index, characteristic, fn) {
        // look for an existing UUID/characteristic pair and update that if the light attributes get updates
        for (let i = 0; i < this.callbackList.length; i++) {
            let callback = this.callbackList[i];
            if (callback.UUID == UUID && callback.characteristic === characteristic) {
                callback = { UUID, type, index, characteristic, fn };
                return;
            }
        }
        // not found, add a new callback.
        this.callbackList.push({ UUID, type, index, characteristic, fn });
    }
    execCallbacks() {
        for (let i = 0; i < this.callbackList.length; i++) {
            let callback = this.callbackList[i];
            try {
                switch (callback.type) {
                    case ZD_Light_1.ILightType.ZD:
                    case ZD_Light_1.ILightType.ZDC:
                        if (callback.characteristic.name === this.platform.Characteristic.Brightness.name) {
                            for (let i in this.GroupList) { // need to use loop as these are not 0 based indexes
                                if (this.GroupList[i].GroupNumber === callback.index) {
                                    if (typeof this.GroupList[i].Intensity !== 'undefined')
                                        callback.fn(this.GroupList[i].Intensity);
                                    break;
                                }
                            }
                            // let group = this.GroupList.find(g=>g.GroupNumber === callback.index, this.GroupList);
                        }
                        break;
                    case ZD_Light_1.ILightType.THEME:
                        if (callback.characteristic.name === this.platform.Characteristic.On.name) {
                            for (let i in this.GroupList) { // need to use loop as these are not 0 based indexes
                                if (this.ThemeList[i].ThemeIndex === callback.index) {
                                    if (typeof this.ThemeList[i].OnOff !== 'undefined')
                                        callback.fn(this.ThemeList[i].OnOff === 1);
                                    break;
                                }
                            }
                        }
                        break;
                }
            }
            catch (err) {
                this.log.error(`execCallbacks: ${err}`);
            }
        }
    }
    async updateLights(force = false) {
        if (force) {
            this.cacheGroupList = undefined;
            this.cacheThemeList = undefined;
        }
        await this.GroupListGetAsync();
        await this.ThemeListGetAsync();
        this.execCallbacks();
    }
    async pollController() {
        try {
            await this.updateLights();
        }
        catch (err) {
            this.log.error(`${this.name} error: ${err}`);
        }
        finally {
            setTimeout(async () => { await this.pollController(); }, 30 * 1000);
        }
    }
}
exports.BaseController = BaseController;
var IControllerType;
(function (IControllerType) {
    IControllerType["ZD"] = "ZD";
    IControllerType["ZDC"] = "ZDC";
    IControllerType["ZDTWO"] = "ZDTWO";
})(IControllerType = exports.IControllerType || (exports.IControllerType = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmFzZUNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29udHJvbGxlci9CYXNlQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQSxpREFBZ0Q7QUFFaEQscURBQTZCO0FBRTdCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFFdkMsTUFBYSxjQUFjO0lBZXpCLFlBQVksSUFBUyxFQUFFLEdBQVE7UUFDN0IsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQTtRQUNuQixJQUFJLE9BQU8sSUFBSSxDQUFDLEVBQUUsS0FBSyxXQUFXLEVBQUU7WUFDbEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztZQUNoRCxPQUFPO1NBQ1I7UUFDRCxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQzVCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDOUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUM7UUFFaEQsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxJQUFJLHFCQUFxQixJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMvRCx1QkFBdUI7UUFDdkIsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFLEdBQUcsTUFBTSxJ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XG5pbXBvcnQgeyBDaGFyYWN0ZXJpc3RpYywgTG9nZ2VyIH0gZnJvbSBcImhvbWVicmlkZ2VcIjtcbmltcG9ydCB7IElMaWdodFR5cGUgfSBmcm9tIFwiLi4vbGlnaHRzL1pEX0xpZ2h0XCI7XG5pbXBvcnQgeyBMdXhvclBsYXRmb3JtIH0gZnJvbSBcIi4uL0x1eG9yUGxhdGZvcm1cIjtcbmltcG9ydCBRdWV1ZSBmcm9tIFwiLi4vUXVldWVcIjtcblxuY29uc3QgYXhpb3MgPSByZXF1aXJlKCdheGlvcycpLmRlZmF1bHQ7XG5cbmV4cG9ydCBjbGFzcyBCYXNlQ29udHJvbGxlciB7XG4gIHByb3RlY3RlZCBpcDogc3RyaW5nO1xuICBwdWJsaWMgbmFtZTogc3RyaW5nO1xuICBwcm90ZWN0ZWQgaGlkZUdyb3VwczogYm9vbGVhbjtcbiAgcHJvdGVjdGVkIGluZGVwZW5kZW50Q29sb3JzOiBib29sZWFuO1xuICBwcm90ZWN0ZWQgbG9nOiBMb2dnZXI7XG4gIHB1YmxpYyB0eXBlOiBJQ29udHJvbGxlclR5cGU7XG4gIHByb3RlY3RlZCBwbGF0Zm9ybTogTHV4b3JQbGF0Zm9ybTtcbiAgcHJvdGVjdGVkIEdyb3VwTGlzdDogSUdyb3VwTGlzdFtdO1xuICBwcm90ZWN0ZWQgY2FjaGVHcm91cExpc3Q6IG51bWJlcjtcbiAgcHJvdGVjdGVkIENvbG9yTGlzdDogSUNvbG9yTGlzdFtdO1xuICBwcm90ZWN0ZWQgY2FjaGVDb2xvckxpc3Q6IG51bWJlcjtcbiAgcHJvdGVjdGVkIFRoZW1lTGlzdDogSVRoZW1lTGlzdFtdO1xuICBwcm90ZWN0ZWQgY2FjaGVUaGVtZUxpc3Q6IG51bWJlcjtcbiAgcHJvdGVjdGVkIGNhbGxiYWNrTGlzdDogeyBVVUlEOiBzdHJpbmcsIHR5cGU6IElMaWdodFR5cGUsIGluZGV4OiBudW1iZXIsIGNoYXJhY3RlcmlzdGljOiBhbnksIGZuOiAoYTogbnVtYmVyIHwgYm9vbGVhbikgPT4ge30gfVtdO1xuICBjb25zdHJ1Y3RvcihkYXRhOiBhbnksIGxvZzogYW55KSB7XG4gICAgdGhpcy5sb2cgPSBsb2c7XG4gICAgdGhpcy5jYWxsYmFja0xpc3QgPSBbXTtcbiAgICB0aGlzLkdyb3VwTGlzdCA9IFtdXG4gICAgaWYgKHR5cGVvZiBkYXRhLmlwID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhpcy5sb2cuZGVidWcoYEluaXRpYWxpemluZyBiYXNlIGNvbnRyb2xsZXIuYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuaXAgPSBkYXRhLmlwO1xuICAgIHRoaXMubmFtZSA9IGRhdGEuQ29udHJvbGxlcjtcbiAgICB0aGlzLnR5cGUgPSBkYXRhLnR5cGU7XG4gICAgdGhpcy5wbGF0Zm9ybSA9IGRhdGEucGxhdGZvcm07XG4gICAgdGhpcy5oaWRlR3JvdXBzID0gZGF0YS5oaWRlR3JvdXBzO1xuICAgIHRoaXMuaW5kZXBlbmRlbnRDb2xvcnMgPSBkYXRhLmluZGVwZW5kZW50Q29sb3JzO1xuXG4gICAgbG9nLmluZm8oYEFzc2lnbmluZyAke3RoaXMudHlwZX0gQ29udHJvbGxlciB0byBJUCAke3RoaXMuaXB9YCk7XG4gICAgLy8gdGhpcy51cGRhdGVMaWdodHMoKTtcbiAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsgYXdhaXQgdGhpcy5wb2xsQ29udHJvbGxlcigpOyB9LCAzMDAwMCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0U3RhdHVzKHJlc3VsdCk6IHN0cmluZyB7XG4gICAgc3dpdGNoIChyZXN1bHQpIHtcbiAgICAgIGNhc2UgMDpcbiAgICAgICAgcmV0dXJuICgnT2snKTsgLy9TdGF0dXNPa1xuICAgICAgY2FzZSAoMSk6XG4gICAgICAgIHJldHVybiAoJ1Vua25vd24gTWV0aG9kJyk7IC8vU3RhdHVzVW5rbm93bk1ldGhvZFxuICAgICAgY2FzZSAoMTAxKTpcbiAgICAgICAgcmV0dXJuICgnVW5wYXJzZWFibGUgUmVxdWVzdCcpOyAvL1N0YXR1c1VucGFyc2VhYmxlUmVxdWVzdFxuICAgICAgY2FzZSAoMTAyKTpcbiAgICAgICAgcmV0dXJuICgnSW52YWxpZCBSZXF1ZXN0Jyk7IC8vU3RhdHVzSW52YWxpZFJlcXVlc3RcbiAgICAgIGNhc2UgKDE1MSk6XG4gICAgICAgIHJldHVybiAoJ0NvbG9yIFZhbHVlIE91dCBvZiBSYW5nZScpO1xuICAgICAgY2FzZSAoMjAxKTpcbiAgICAgICAgcmV0dXJuICgnUHJlY29uZGl0aW9uIEZhaWxlZCcpOyAvL1N0YXR1c1ByZWNvbmRpdGlvbkZhaWxlZFxuICAgICAgY2FzZSAoMjAyKTpcbiAgICAgICAgcmV0dXJuICgnR3JvdXAgTmFtZSBJbiBVc2UnKTsgLy9TdGF0dXNHcm91cE5hbWVJblVzZVxuICAgICAgY2FzZSAoMjA1KTpcbiAgICAgICAgcmV0dXJuICgnR3JvdXAgTnVtYmVyIEluIFVzZScpOyAvL1N0YXR1c0dyb3VwTnVtYmVySW5Vc2VcbiAgICAgIGNhc2UgKDI0MSk6XG4gICAgICAgIHJldHVybiAoJ0l0ZW0gRG9lcyBOb3QgRXhpc3QnKTsgLy9TdGF0dXNUaGVtZUluZGV4T3V0T2ZSYW5nZVxuICAgICAgY2FzZSAoMjQyKTpcbiAgICAgICAgcmV0dXJuICgnQmFkIEdyb3VwIE51bWJlcicpOyAvL1N0YXR1c1RoZW1lSW5kZXhPdXRPZlJhbmdlXG4gICAgICBjYXNlICgyNDMpOlxuICAgICAgICByZXR1cm4gKCdUaGVtZSBJbmRleCBPdXQgT2YgUmFuZ2UnKTsgLy9TdGF0dXNUaGVtZUluZGV4T3V0T2ZSYW5nZVxuICAgICAgY2FzZSAoMjUxKTpcbiAgICAgICAgcmV0dXJuICgnQmFkIFRoZW1lIEluZGV4Jyk7IC8vU3RhdHVzVGhlbWVJbmRleE91dE9mUmFuZ2VcbiAgICAgIGNhc2UgKDI1Mik6XG4gICAgICAgIHJldHVybiAoJ1RoZW1lIENoYW5nZXMgUmVzdHJpY3RlZCcpOyAvL1N0YXR1c1RoZW1lSW5kZXhPdXRPZlJhbmdlXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gKCdVbmtub3duIHN0YXR1cycpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRvUmVxdWVzdCh1cmw6IHN0cmluZywgZGF0YT86IGFueSk6IFByb21pc2U8SVRoZW1lTGlzdFJlc3AgfCBJR3JvdXBMaXN0UmVzcCB8IElDb2xvckxpc3RSZXNwIHwgSVN0YXR1cz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KTogUHJvbWlzZTxJVGhlbWVMaXN0UmVzcCB8IElHcm91cExpc3RSZXNwIHwgSUNvbG9yTGlzdFJlc3AgfCBJU3RhdHVzPiA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBzd2l0Y2ggKHVybCkge1xuICAgICAgICAgIGNhc2UgJ0dyb3VwTGlzdEdldCc6XG4gICAgICAgICAgICBpZiAodGhpcy5oaWRlR3JvdXBzKSByZXR1cm47XG4gICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuY2FjaGVHcm91cExpc3QgIT09ICd1bmRlZmluZWQnICYmIERhdGUubm93KCkgLSB0aGlzLmNhY2hlR3JvdXBMaXN0IDwgMjAwMCkge1xuICAgICAgICAgICAgICByZXNvbHZlKHsgU3RhdHVzOiAxLCBTdGF0dXNTdHI6ICdDYWNoZWQnLCBHcm91cExpc3Q6IHRoaXMuR3JvdXBMaXN0IH0pO1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdUaGVtZUxpc3RHZXQnOlxuICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmNhY2hlVGhlbWVMaXN0ICE9PSAndW5kZWZpbmVkJyAmJiBEYXRlLm5vdygpIC0gdGhpcy5jYWNoZVRoZW1lTGlzdCA8IDIwMDApIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZSh7IFN0YXR1czogMSwgU3RhdHVzU3RyOiAnQ2FjaGVkJywgVGhlbWVMaXN0OiB0aGlzLlRoZW1lTGlzdCB9KTtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnQ29sb3JMaXN0R2V0JzpcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5jYWNoZUNvbG9yTGlzdCAhPT0gJ3VuZGVmaW5lZCcgJiYgRGF0ZS5ub3coKSAtIHRoaXMuY2FjaGVDb2xvckxpc3QgPCAyMDAwKSB7XG4gICAgICAgICAgICAgIHJlc29sdmUoeyBTdGF0dXM6IDEsIFN0YXR1c1N0cjogJ0NhY2hlZCcsIENvbG9yTGlzdDogdGhpcy5Db2xvckxpc3QgfSk7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3Moe1xuICAgICAgICAgIG1ldGhvZDogJ3Bvc3QnLFxuICAgICAgICAgIHVybDogJ2h0dHA6Ly8nICsgdGhpcy5pcCArICcvJyArIHVybCArICcuanNvbicsXG4gICAgICAgICAgZGF0YSxcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnY2FjaGUtY29udHJvbCc6ICduby1jYWNoZSdcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRpbWVvdXQ6IDc1MFxuICAgICAgICB9KVxuICAgICAgICByZXNwb25zZS5kYXRhLlN0YXR1c1N0ciA9IHRoaXMuZ2V0U3RhdHVzKHJlc3BvbnNlLmRhdGEuU3RhdHVzKTtcbiAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuU3RhdHVzU3RyICE9PSAnT2snIHx8IHJlc3BvbnNlLmNvZGUgPT09ICdFVElNRU9VVCcpIHtcbiAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgQ29udHJvbGxlciAke3RoaXMubmFtZX0gcmVzcG9uZGVkIHdpdGggZXJyb3IgJHtyZXNwb25zZS5kYXRhLlN0YXR1c1N0cn0gdG8gJyR7dXJsfSdgKTtcbiAgICAgICAgICByZXNvbHZlKHsgU3RhdHVzOiAxLCBTdGF0dXNTdHI6ICdPaycsIEdyb3VwTGlzdDogdGhpcy5Hcm91cExpc3QgfHwgW10sIFRoZW1lTGlzdDogdGhpcy5UaGVtZUxpc3QgfHwgW10sIENvbG9yTGlzdDogdGhpcy5Db2xvckxpc3QgfHwgW10gfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZVxuICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UuZGF0YSk7XG4gICAgICB9XG4gICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRoaXMubG9nLmVycm9yKGBFcnJvciBjb21tdW5pY2F0aW5nIHdpdGggY29udHJvbGxlciAke3RoaXMubmFtZX0uIFVSTCAke3VybH0uanNvbi5cXG5cXHQke2Vycn1gKTtcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGFzeW5jIHNsZWVwKG1zKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpO1xuICB9XG4gIGFzeW5jIElsbHVtaW5hdGVBbGxBc3luYygpOiBQcm9taXNlPElTdGF0dXM+IHtcbiAgICByZXR1cm4gUXVldWUuZW5xdWV1ZShhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3RhdHVzID0gYXdhaXQgdGhpcy5kb1JlcXVlc3QoJ0lsbHVtaW5hdGVBbGwnKTtcbiAgICAgIHJldHVybiBzdGF0dXM7XG4gICAgfSlcbiAgfVxuXG4gIGFzeW5jIEV4dGluZ3Vpc2hBbGxBc3luYygpOiBQcm9taXNlPElTdGF0dXM+IHtcbiAgICByZXR1cm4gUXVldWUuZW5xdWV1ZShhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3RhdHVzID0gYXdhaXQgdGhpcy5kb1JlcXVlc3QoJ0V4dGluZ3Vpc2hBbGwnKTtcbiAgICAgIHJldHVybiBzdGF0dXM7XG4gICAgfSlcbiAgfVxuICBwdWJsaWMgYXN5bmMgR2V0R3JvdXBBc3luYyhncm91cDogbnVtYmVyKTogUHJvbWlzZTxJR3JvdXBMaXN0PiB7XG4gICAgaWYgKHRoaXMuaGlkZUdyb3VwcykgcmV0dXJuO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLkdyb3VwTGlzdEdldEFzeW5jKCk7XG4gICAgICAgIGZvciAobGV0IGkgaW4gdGhpcy5Hcm91cExpc3QpIHtcbiAgICAgICAgICBpZiAodGhpcy5Hcm91cExpc3RbaV0uR3JvdXBOdW1iZXIgPT09IGdyb3VwKSByZXR1cm4gcmVzb2x2ZSh0aGlzLkdyb3VwTGlzdFtpXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVqZWN0KGBObyBHcm91cCBGb3VuZCBpbiBHcm91cEdldEFzeW5jIGZvciBncm91cCAke2dyb3VwfS5cXG4ke0pTT04uc3RyaW5naWZ5KHRoaXMuR3JvdXBMaXN0KX1gKVxuICAgICAgfVxuICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICByZWplY3QoYEVycm9yIHdpdGggR2V0R3JvdXBBc3luYzogJHtlcnJ9YClcbiAgICAgICAgdGhpcy5sb2cuZXJyb3IoZXJyKTtcbiAgICAgIH1cbiAgICB9KVxuICB9XG4gIGFzeW5jIEdyb3VwTGlzdEdldEFzeW5jKCk6IFByb21pc2U8SUdyb3VwTGlzdFtdPiB7XG4gICAgLy8gR2V0IHRoZSBsaXN0IG9mIGxpZ2h0IGdyb3VwcyBmcm9tIHRoZSBjb250cm9sbGVyXG4gICAgaWYgKHR5cGVvZiB0aGlzLmNhY2hlR3JvdXBMaXN0ICE9PSAndW5kZWZpbmVkJyAmJiBEYXRlLm5vdygpIC0gdGhpcy5jYWNoZUdyb3VwTGlzdCA8IDIwMDApIHtcbiAgICAgIHJldHVybiAodGhpcy5Hcm91cExpc3QpO1xuICAgIH1cblxuICAgIHJldHVybiBRdWV1ZS5lbnF1ZXVlKGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBkYXRhID0gYXdhaXQgdGhpcy5kb1JlcXVlc3QoJ0dyb3VwTGlzdEdldCcpO1xuICAgICAgaWYgKGRhdGEuU3RhdHVzID09PSAwKSB7XG4gICAgICAgIHRoaXMuY2FjaGVHcm91cExpc3QgPSBEYXRlLm5vdygpO1xuICAgICAgICB0aGlzLnByb2Nlc3NHcm91cExpc3RHZXQoZGF0YSBhcyBJR3JvdXBMaXN0UmVzcCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5Hcm91cExpc3Q7XG4gICAgfSlcbiAgfVxuICBwcm90ZWN0ZWQgcHJvY2Vzc0dyb3VwTGlzdEdldChkYXRhOiBJR3JvdXBMaXN0UmVzcCk6IHZvaWQge1xuICAgIC8vIG92ZXJyaWRlIHdpdGggWkRDL1pEVFdPXG4gICAgdGhpcy5Hcm91cExpc3QgPSBkYXRhLkdyb3VwTGlzdDtcbiAgICBmb3IgKGxldCBpIGluIHRoaXMuR3JvdXBMaXN0KSB7XG4gICAgICB0aGlzLkdyb3VwTGlzdFtpXS50eXBlID0gSUxpZ2h0VHlwZS5aRDtcbiAgICB9XG4gIH1cbiAgYXN5bmMgR3JvdXBMaXN0RWRpdEFzeW5jKG5hbWU6IHN0cmluZywgZ3JvdXBOdW1iZXI6IG51bWJlciwgY29sb3I/OiBudW1iZXIpOiBQcm9taXNlPGFueT4ge1xuICAgIC8vIFNhbWUgaW4gWkRDL1pEVFdPXG4gICAgdmFyIHJlcXVlc3REYXRhID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgJ05hbWUnOiBuYW1lLFxuICAgICAgJ0dyb3VwTnVtYmVyJzogZ3JvdXBOdW1iZXIsXG4gICAgICAnQ29sb3InOiBjb2xvclxuICAgIH0pO1xuICAgIHJldHVybiBRdWV1ZS5lbnF1ZXVlKGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBzdGF0dXMgPSBhd2FpdCB0aGlzLmRvUmVxdWVzdCgnR3JvdXBMaXN0RWRpdCcsIHJlcXVlc3REYXRhKTtcbiAgICAgIHJldHVybiBzdGF0dXM7XG4gICAgfSlcbiAgICAvKiAgICAgbGV0IHN0YXR1cyA9IGF3YWl0IHRoaXMucXVldWVSZXF1ZXN0KCdHcm91cExpc3RFZGl0JywgcmVxdWVzdERhdGEpO1xuICAgICAgICByZXR1cm4gc3RhdHVzOyAqL1xuICB9XG4gIGFzeW5jIFRoZW1lTGlzdEdldEFzeW5jKCk6IFByb21pc2U8SVRoZW1lTGlzdFtdPiB7XG4gICAgaWYgKHR5cGVvZiB0aGlzLmNhY2hlVGhlbWVMaXN0ICE9PSAndW5kZWZpbmVkJyAmJiBEYXRlLm5vdygpIC0gdGhpcy5jYWNoZVRoZW1lTGlzdCA8IDIwMDApIHtcbiAgICAgIHJldHVybiAodGhpcy5UaGVtZUxpc3QpO1xuICAgIH1cbiAgICByZXR1cm4gUXVldWUuZW5xdWV1ZShhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgZGF0YSA9IGF3YWl0IHRoaXMuZG9SZXF1ZXN0KCdUaGVtZUxpc3RHZXQnKTtcbiAgICAgIGlmIChkYXRhLlN0YXR1cyA9PT0gMCkge1xuICAgICAgICB0aGlzLmNhY2hlVGhlbWVMaXN0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgdGhpcy5wcm9jZXNzVGhlbWVMaXN0R2V0KGRhdGEgYXMgSVRoZW1lTGlzdFJlc3ApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMuVGhlbWVMaXN0O1xuICAgIH0pXG4gIH1cbiAgcHJvdGVjdGVkIHByb2Nlc3NUaGVtZUxpc3RHZXQoZGF0YTogSVRoZW1lTGlzdFJlc3ApOiB2b2lkIHtcbiAgICB0aGlzLlRoZW1lTGlzdCA9IGRhdGEuVGhlbWVMaXN0O1xuICAgIGZvciAodmFyIGkgaW4gdGhpcy5UaGVtZUxpc3QpIHtcbiAgICAgIHRoaXMuVGhlbWVMaXN0W2ldLmlzT24gPSB0aGlzLlRoZW1lTGlzdFtpXS5Pbk9mZiA9PT0gMTtcbiAgICAgIHRoaXMuVGhlbWVMaXN0W2ldLnR5cGUgPSBJTGlnaHRUeXBlLlRIRU1FO1xuICAgIH1cbiAgfVxuICBwdWJsaWMgYXN5bmMgR2V0VGhlbWVBc3luYyhpbmRleDogbnVtYmVyKTogUHJvbWlzZTxJVGhlbWVMaXN0PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuVGhlbWVMaXN0R2V0QXN5bmMoKTtcbiAgICAgICAgZm9yIChsZXQgaSBpbiB0aGlzLlRoZW1lTGlzdCkge1xuICAgICAgICAgIGlmICh0aGlzLlRoZW1lTGlzdFtpXS5UaGVtZUluZGV4ID09PSBpbmRleCkgcmV0dXJuIHJlc29sdmUodGhpcy5UaGVtZUxpc3RbaV0pO1xuICAgICAgICB9XG4gICAgICAgIHJlamVjdChgTm8gVGhlbWUgRm91bmQgaW4gVGhlbWVHZXRBc3luYyBmb3IgdGhlbWUgJHtpbmRleH0uXFxuJHtKU09OLnN0cmluZ2lmeSh0aGlzLlRoZW1lTGlzdCl9YClcbiAgICAgIH1cbiAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhpcy5sb2cuZXJyb3IoZXJyKTtcbiAgICAgICAgcmVqZWN0KGBFcnJvciB3aXRoIEdldFRoZW1lQXN5bmMgJHtlcnJ9YClcbiAgICAgIH1cbiAgICB9KVxuXG4gIH1cbiAgYXN5bmMgSWxsdW1pbmF0ZVRoZW1lQXN5bmModGhlbWVJbmRleDogbnVtYmVyLCBvbk9mZjogbnVtYmVyKTogUHJvbWlzZTxJU3RhdHVzPiB7XG4gICAgcmV0dXJuIFF1ZXVlLmVucXVldWUoYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHN0YXR1cyA9IGF3YWl0IHRoaXMuZG9SZXF1ZXN0KCdJbGx1bWluYXRlVGhlbWUnLCB7XG4gICAgICAgICdUaGVtZUluZGV4JzogdGhlbWVJbmRleCxcbiAgICAgICAgJ09uT2ZmJzogb25PZmZcbiAgICAgIH0pO1xuICAgICAgdGhpcy5jYWNoZVRoZW1lTGlzdCA9IHVuZGVmaW5lZDtcbiAgICAgIHNldFRpbWVvdXQoYXN5bmMgKCkgPT4geyBhd2FpdCB0aGlzLnVwZGF0ZUxpZ2h0cygpIH0sIDI1MCk7XG4gICAgICByZXR1cm4gc3RhdHVzO1xuICAgIH0pXG4gIH1cbiAgYXN5bmMgSWxsdW1pbmF0ZUdyb3VwQXN5bmMoZ3JvdXBOdW1iZXI6IG51bWJlciwgZGVzaXJlZEludGVuc2l0eTogbnVtYmVyKTogUHJvbWlzZTxJU3RhdHVzPiB7XG4gICAgcmV0dXJuIFF1ZXVlLmVucXVldWUoYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHN0YXR1cyA9IGF3YWl0IHRoaXMuZG9SZXF1ZXN0KCdJbGx1bWluYXRlR3JvdXAnLCB7XG4gICAgICAgICdHcm91cE51bWJlcic6IGdyb3VwTnVtYmVyLFxuICAgICAgICAnSW50ZW5zaXR5JzogZGVzaXJlZEludGVuc2l0eVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gc3RhdHVzO1xuICAgIH0pXG4gIH1cbiAgYXN5bmMgQ29sb3JMaXN0R2V0QXN5bmMoKTogUHJvbWlzZTxJQ29sb3JMaXN0W10+IHtcbiAgICByZXR1cm4ge30gYXMgSUNvbG9yTGlzdFtdO1xuICB9XG4gIGFzeW5jIENvbG9yTGlzdFNldEFzeW5jKGNvbG9yOiBudW1iZXIsIGh1ZTogbnVtYmVyLCBzYXR1cmF0aW9uOiBudW1iZXIpOiBQcm9taXNlPElTdGF0dXM+IHtcbiAgICByZXR1cm4ge30gYXMgSVN0YXR1cztcbiAgfVxuICBwcm9jZXNzQ29sb3JMaXN0R2V0KGRhdGE6IElDb2xvckxpc3RSZXNwKSB7XG4gICAgdGhpcy5Db2xvckxpc3QgPSBkYXRhLkNvbG9yTGlzdDtcbiAgfTtcbiAgYXN5bmMgR2V0Q29sb3JBc3luYyhjb2xvcjogbnVtYmVyKTogUHJvbWlzZTxJQ29sb3JMaXN0PiB7IHJldHVybiB7fSBhcyBJQ29sb3JMaXN0OyB9XG5cbiAgcmVnaXN0ZXJDYWxsYmFjayhVVUlEOiBzdHJpbmcsIHR5cGU6IElMaWdodFR5cGUsIGluZGV4OiBudW1iZXIsIGNoYXJhY3RlcmlzdGljOiBhbnksIGZuOiAoKSA9PiB7fSkge1xuICAgIC8vIGxvb2sgZm9yIGFuIGV4aXN0aW5nIFVVSUQvY2hhcmFjdGVyaXN0aWMgcGFpciBhbmQgdXBkYXRlIHRoYXQgaWYgdGhlIGxpZ2h0IGF0dHJpYnV0ZXMgZ2V0IHVwZGF0ZXNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY2FsbGJhY2tMaXN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgY2FsbGJhY2sgPSB0aGlzLmNhbGxiYWNrTGlzdFtpXTtcbiAgICAgIGlmIChjYWxsYmFjay5VVUlEID09IFVVSUQgJiYgY2FsbGJhY2suY2hhcmFjdGVyaXN0aWMgPT09IGNoYXJhY3RlcmlzdGljKSB7XG4gICAgICAgIGNhbGxiYWNrID0geyBVVUlELCB0eXBlLCBpbmRleCwgY2hhcmFjdGVyaXN0aWMsIGZuIH07XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gbm90IGZvdW5kLCBhZGQgYSBuZXcgY2FsbGJhY2suXG4gICAgdGhpcy5jYWxsYmFja0xpc3QucHVzaCh7IFVVSUQsIHR5cGUsIGluZGV4LCBjaGFyYWN0ZXJpc3RpYywgZm4gfSk7XG4gIH1cbiAgZXhlY0NhbGxiYWNrcygpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY2FsbGJhY2tMaXN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgY2FsbGJhY2sgPSB0aGlzLmNhbGxiYWNrTGlzdFtpXTtcbiAgICAgIHRyeSB7XG4gICAgICAgIHN3aXRjaCAoY2FsbGJhY2sudHlwZSkge1xuICAgICAgICAgIGNhc2UgSUxpZ2h0VHlwZS5aRDpcbiAgICAgICAgICBjYXNlIElMaWdodFR5cGUuWkRDOlxuICAgICAgICAgICAgaWYgKGNhbGxiYWNrLmNoYXJhY3RlcmlzdGljLm5hbWUgPT09IHRoaXMucGxhdGZvcm0uQ2hhcmFjdGVyaXN0aWMuQnJpZ2h0bmVzcy5uYW1lKSB7XG4gICAgICAgICAgICAgIGZvciAobGV0IGkgaW4gdGhpcy5Hcm91cExpc3QpeyAvLyBuZWVkIHRvIHVzZSBsb29wIGFzIHRoZXNlIGFyZSBub3QgMCBiYXNlZCBpbmRleGVzXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuR3JvdXBMaXN0W2ldLkdyb3VwTnVtYmVyID09PSBjYWxsYmFjay5pbmRleCl7XG4gICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuR3JvdXBMaXN0W2ldLkludGVuc2l0eSAhPT0gJ3VuZGVmaW5lZCcpIGNhbGxiYWNrLmZuKHRoaXMuR3JvdXBMaXN0W2ldLkludGVuc2l0eSk7XG4gICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgLy8gbGV0IGdyb3VwID0gdGhpcy5Hcm91cExpc3QuZmluZChnPT5nLkdyb3VwTnVtYmVyID09PSBjYWxsYmFjay5pbmRleCwgdGhpcy5Hcm91cExpc3QpO1xuICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgSUxpZ2h0VHlwZS5USEVNRTpcbiAgICAgICAgICAgIGlmIChjYWxsYmFjay5jaGFyYWN0ZXJpc3RpYy5uYW1lID09PSB0aGlzLnBsYXRmb3JtLkNoYXJhY3RlcmlzdGljLk9uLm5hbWUpIHtcbiAgICAgICAgICAgICAgZm9yIChsZXQgaSBpbiB0aGlzLkdyb3VwTGlzdCl7IC8vIG5lZWQgdG8gdXNlIGxvb3AgYXMgdGhlc2UgYXJlIG5vdCAwIGJhc2VkIGluZGV4ZXNcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5UaGVtZUxpc3RbaV0uVGhlbWVJbmRleCA9PT0gY2FsbGJhY2suaW5kZXgpe1xuICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLlRoZW1lTGlzdFtpXS5Pbk9mZiAhPT0gJ3VuZGVmaW5lZCcpIGNhbGxiYWNrLmZuKHRoaXMuVGhlbWVMaXN0W2ldLk9uT2ZmID09PSAxKTtcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhpcy5sb2cuZXJyb3IoYGV4ZWNDYWxsYmFja3M6ICR7ZXJyfWApXG4gICAgICB9XG4gICAgfVxuICB9XG4gIGFzeW5jIHVwZGF0ZUxpZ2h0cyhmb3JjZTogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgaWYgKGZvcmNlKSB7XG4gICAgICB0aGlzLmNhY2hlR3JvdXBMaXN0ID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5jYWNoZVRoZW1lTGlzdCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5Hcm91cExpc3RHZXRBc3luYygpO1xuICAgIGF3YWl0IHRoaXMuVGhlbWVMaXN0R2V0QXN5bmMoKTtcbiAgICB0aGlzLmV4ZWNDYWxsYmFja3MoKTtcbiAgfVxuICBhc3luYyBwb2xsQ29udHJvbGxlcigpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy51cGRhdGVMaWdodHMoKTtcbiAgICB9XG4gICAgY2F0Y2ggKGVycikgeyB0aGlzLmxvZy5lcnJvcihgJHt0aGlzLm5hbWV9IGVycm9yOiAke2Vycn1gKSB9XG4gICAgZmluYWxseSB7IHNldFRpbWVvdXQoYXN5bmMgKCkgPT4geyBhd2FpdCB0aGlzLnBvbGxDb250cm9sbGVyKCkgfSwgMzAgKiAxMDAwKTsgfVxuICB9XG5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJR3JvdXBMaXN0UmVzcCB7XG4gIFN0YXR1czogbnVtYmVyO1xuICBTdGF0dXNTdHI6IHN0cmluZztcbiAgR3JvdXBMaXN0OiBJR3JvdXBMaXN0W107XG59XG5leHBvcnQgaW50ZXJmYWNlIElHcm91cExpc3Qge1xuICBOYW1lOiBzdHJpbmc7XG4gIEdycD86IG51bWJlcjtcbiAgR3JvdXBOdW1iZXI/OiBudW1iZXI7XG4gIENvbHI/OiBudW1iZXI7XG4gIENvbG9yPzogbnVtYmVyO1xuICBJbnRlbj86IG51bWJlcjtcbiAgSW50ZW5zaXR5PzogbnVtYmVyO1xuICB0eXBlOiBJTGlnaHRUeXBlO1xuICBVVUlEPzogc3RyaW5nO1xufVxuZXhwb3J0IGludGVyZmFjZSBJU3RhdHVzIHtcbiAgU3RhdHVzOiBudW1iZXI7XG4gIFN0YXR1c1N0cjogc3RyaW5nO1xufVxuZXhwb3J0IGludGVyZmFjZSBJVGhlbWVMaXN0UmVzcCB7XG4gIFN0YXR1czogbnVtYmVyO1xuICBTdGF0dXNTdHI6IHN0cmluZztcbiAgUmVzdHJpY3RlZDogMCB8IDE7XG4gIFRoZW1lTGlzdDogSVRoZW1lTGlzdFtdO1xufVxuZXhwb3J0IGludGVyZmFjZSBJVGhlbWVMaXN0IHtcbiAgTmFtZTogc3RyaW5nO1xuICBUaGVtZUluZGV4OiBudW1iZXI7XG4gIE9uT2ZmOiAwIHwgMTtcbiAgaXNPbjogYm9vbGVhbjtcbiAgdHlwZT86IElMaWdodFR5cGU7XG4gIFVVSUQ/OiBzdHJpbmc7XG59XG5leHBvcnQgaW50ZXJmYWNlIElDb2xvckxpc3RSZXNwIHtcbiAgU3RhdHVzOiBudW1iZXI7XG4gIFN0YXR1c1N0cjogc3RyaW5nO1xuICBMaXN0U2l6ZTogbnVtYmVyO1xuICBDb2xvckxpc3Q6IElDb2xvckxpc3RbXTtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgSUNvbG9yTGlzdCB7XG4gIEM6IG51bWJlcjtcbiAgSHVlOiBudW1iZXI7XG4gIFNhdDogbnVtYmVyO1xufVxuZXhwb3J0IGVudW0gSUNvbnRyb2xsZXJUeXBlIHtcbiAgWkQgPSAnWkQnLCBaREMgPSAnWkRDJywgWkRUV08gPSAnWkRUV08nXG59Il19